<!-- Reports Page Fragment -->
<style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
      font-family: 'Poppins', sans-serif; 
    }
    
    body { 
      background: #f5f7fa; 
      color: #2c3e50;
    }
    
    .reports-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .page-header {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      text-align: center;
    }
    
    .page-header h1 {
      color: #2c3e50;
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    
    .page-header p {
      color: #7f8c8d;
      font-size: 1.1rem;
    }
    
    .reports-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .report-card {
      background: white;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      border-left: 4px solid #3498db;
    }
    
    .report-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    }
    
    .report-card.sales { border-left-color: #e74c3c; }
    .report-card.inventory { border-left-color: #f39c12; }
    .report-card.financial { border-left-color: #27ae60; }
    .report-card.customers { border-left-color: #9b59b6; }
    
    .report-card h3 {
      color: #2c3e50;
      font-size: 1.3rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }
    
    .report-card h3 i {
      margin-right: 10px;
      font-size: 1.5rem;
    }
    
    .report-card p {
      color: #7f8c8d;
      line-height: 1.6;
      margin-bottom: 20px;
    }
    
    .report-btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
    }
    
    .report-btn:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }
    
    .report-btn i {
      margin-right: 8px;
    }
    
    .coming-soon {
      background: #fff3cd;
      color: #856404;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      margin-top: 20px;
      border: 1px solid #ffeaa7;
    }
    
    .coming-soon h3 {
      margin-bottom: 10px;
      color: #856404;
    }
    
    @media (max-width: 768px) {
      .reports-grid {
        grid-template-columns: 1fr;
      }
      
      .page-header h1 {
        font-size: 2rem;
      }
    }
    
    @media (max-width: 1024px) {
      .container {
        padding: 15px;
      }
      
      .reports-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .page-header {
        padding: 15px;
        margin-bottom: 15px;
      }
      
      .page-header h1 {
        font-size: 1.5rem;
      }
      
      .page-header p {
        font-size: 0.9rem;
      }
      
      .reports-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .report-card {
        padding: 15px;
      }
      
      .report-card h3 {
        font-size: 1rem;
      }
      
      .report-btn {
        padding: 10px 15px;
        font-size: 13px;
      }
    }
    
    @media (max-width: 480px) {
      .page-header h1 {
        font-size: 1.2rem;
      }
      
      .report-card h3 {
        font-size: 0.9rem;
      }
      
      .report-btn {
        padding: 8px 12px;
        font-size: 12px;
      }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

  <div class="reports-container">
    <div class="page-header">
      <h1><i class="fas fa-chart-pie"></i> Laporan Sistem</h1>
      <p>Kelola dan lihat berbagai laporan bisnis Anda</p>
    </div>
    
    <div class="reports-grid">
      <div class="report-card sales">
        <h3><i class="fas fa-chart-line"></i> Rekap Penjualan</h3>
        <p>Analisis data penjualan, tren bulanan, dan performa produk terbaik untuk membantu pengambilan keputusan bisnis.</p>
        
        <div style="margin: 15px 0; text-align: left; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
          <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;">Pilih Periode:</label>
          <div style="margin-bottom: 10px;">
            <label style="display: inline-block; margin-right: 15px; cursor: pointer;">
              <input type="radio" name="salesPeriod" value="all" style="margin-right: 5px;">
              Semua Data
            </label>
            <label style="display: inline-block; margin-right: 15px; cursor: pointer;">
              <input type="radio" name="salesPeriod" value="week" style="margin-right: 5px;">
              Minggu Ini
            </label>
            <label style="display: inline-block; margin-right: 15px; cursor: pointer;">
              <input type="radio" name="salesPeriod" value="month" checked style="margin-right: 5px;">
              Bulan Ini
            </label>
            <label style="display: inline-block; cursor: pointer;">
              <input type="radio" name="salesPeriod" value="custom" style="margin-right: 5px;">
              Custom
            </label>
          </div>
          
          <div id="customDateRange" style="display: none; margin-top: 10px;">
            <div style="display: flex; gap: 10px; align-items: center;">
              <div style="flex: 1;">
                <label style="display: block; margin-bottom: 5px; font-size: 12px;">Dari Tanggal:</label>
                <input type="date" id="salesStartDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div style="flex: 1;">
                <label style="display: block; margin-bottom: 5px; font-size: 12px;">Sampai Tanggal:</label>
                <input type="date" id="salesEndDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            </div>
          </div>
        </div>
        
        <button class="report-btn" onclick="generateSalesReport()">
          <i class="fas fa-file-pdf"></i> Generate Laporan
        </button>
      </div>
      
      <div class="report-card inventory">
        <h3><i class="fas fa-boxes"></i> Rekap Inventory</h3>
        <p>Pantau stok barang, identifikasi produk dengan stok rendah, dan analisis perputaran inventory.</p>
        
        <div style="margin: 15px 0; text-align: left; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
          <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;">Pilih Periode:</label>
          <div style="margin-bottom: 10px;">
            <label style="display: inline-block; margin-right: 15px; cursor: pointer;">
              <input type="radio" name="inventoryPeriod" value="all" style="margin-right: 5px;">
              Semua Data
            </label>
            <label style="display: inline-block; margin-right: 15px; cursor: pointer;">
              <input type="radio" name="inventoryPeriod" value="week" style="margin-right: 5px;">
              Minggu Ini
            </label>
            <label style="display: inline-block; margin-right: 15px; cursor: pointer;">
              <input type="radio" name="inventoryPeriod" value="month" checked style="margin-right: 5px;">
              Bulan Ini
            </label>
            <label style="display: inline-block; cursor: pointer;">
              <input type="radio" name="inventoryPeriod" value="custom" style="margin-right: 5px;">
              Custom
            </label>
          </div>
          
          <div id="customInventoryDateRange" style="display: none; margin-top: 10px;">
            <div style="display: flex; gap: 10px; align-items: center;">
              <div style="flex: 1;">
                <label style="display: block; margin-bottom: 5px; font-size: 12px;">Dari Tanggal:</label>
                <input type="date" id="inventoryStartDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div style="flex: 1;">
                <label style="display: block; margin-bottom: 5px; font-size: 12px;">Sampai Tanggal:</label>
                <input type="date" id="inventoryEndDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            </div>
          </div>
        </div>
        
        <button class="report-btn" onclick="generateInventoryReport()">
          <i class="fas fa-file-excel"></i> Generate Laporan
        </button>
      </div>
      
      <div class="report-card financial">
        <h3><i class="fas fa-dollar-sign"></i> Rekap Keuangan</h3>
        <p>Ringkasan pendapatan, pengeluaran, laba rugi, dan analisis profitabilitas bisnis Anda.</p>
        
        <div style="margin: 15px 0; text-align: left; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
          <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #2c3e50;">Pilih Periode:</label>
          <div style="margin-bottom: 10px;">
            <label style="display: inline-block; margin-right: 15px; cursor: pointer;">
              <input type="radio" name="financialPeriod" value="all" style="margin-right: 5px;">
              Semua Data
            </label>
            <label style="display: inline-block; margin-right: 15px; cursor: pointer;">
              <input type="radio" name="financialPeriod" value="week" style="margin-right: 5px;">
              Minggu Ini
            </label>
            <label style="display: inline-block; margin-right: 15px; cursor: pointer;">
              <input type="radio" name="financialPeriod" value="month" checked style="margin-right: 5px;">
              Bulan Ini
            </label>
            <label style="display: inline-block; cursor: pointer;">
              <input type="radio" name="financialPeriod" value="custom" style="margin-right: 5px;">
              Custom
            </label>
          </div>
          
          <div id="customFinancialDateRange" style="display: none; margin-top: 10px;">
            <div style="display: flex; gap: 10px; align-items: center;">
              <div style="flex: 1;">
                <label style="display: block; margin-bottom: 5px; font-size: 12px;">Dari Tanggal:</label>
                <input type="date" id="financialStartDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
              <div style="flex: 1;">
                <label style="display: block; margin-bottom: 5px; font-size: 12px;">Sampai Tanggal:</label>
                <input type="date" id="financialEndDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            </div>
          </div>
        </div>
        
        <button class="report-btn" onclick="generateFinancialReport()">
          <i class="fas fa-file-alt"></i> Generate Laporan
        </button>
      </div>
    </div>
    
    <div class="coming-soon">
      <h3><i class="fas fa-check-circle"></i> Fitur Laporan Aktif</h3>
      <p>Semua laporan telah berhasil diimplementasikan dan siap digunakan. Klik tombol "Generate Laporan" pada setiap jenis laporan untuk melihat data terkini dari Google Sheets.</p>
    </div>
  </div>

  <script>
    // Google Apps Script URL - akan diisi secara dinamis
    let scriptUrl = '';

    // Initialize script URL
    google.script.run.withSuccessHandler(function(url) {
      scriptUrl = url;
    }).getScriptUrl();

    // Toggle custom date range visibility
    // document.addEventListener('DOMContentLoaded', function() {
      // Sales period
      const salesRadios = document.querySelectorAll('input[name="salesPeriod"]');
      salesRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          const customDiv = document.getElementById('customDateRange');
          if (this.value === 'custom') {
            customDiv.style.display = 'block';
          } else {
            customDiv.style.display = 'none';
          }
        });
      });
      
      // Inventory period
      const inventoryRadios = document.querySelectorAll('input[name="inventoryPeriod"]');
      inventoryRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          const customDiv = document.getElementById('customInventoryDateRange');
          if (this.value === 'custom') {
            customDiv.style.display = 'block';
          } else {
            customDiv.style.display = 'none';
          }
        });
      });
      
      // Financial period
      const financialRadios = document.querySelectorAll('input[name="financialPeriod"]');
      financialRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          const customDiv = document.getElementById('customFinancialDateRange');
          if (this.value === 'custom') {
            customDiv.style.display = 'block';
          } else {
            customDiv.style.display = 'none';
          }
        });
      });
    // });

    // Helper function to get Monday of current week
    function getMonday(d) {
      d = new Date(d);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
      return new Date(d.setDate(diff));
    }

    // Helper function to get Sunday of current week
    function getSunday(d) {
      const monday = getMonday(d);
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      return sunday;
    }

    // Helper function to format date for display
    function formatDate(date) {
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function generateSalesReport() {
      try {
        console.log('generateSalesReport started');
        const user = SessionManager.getUser();
        const userEmail = user ? user.username : null;

        const period = document.querySelector('input[name="salesPeriod"]:checked').value;
        console.log('Selected period:', period);
        let filter = null;
        
        if (period === 'all') {
          // No filter - get all data
          filter = {
            startDate: null,
            endDate: null,
            period: 'all'
          };
        } else if (period === 'week') {
          const monday = getMonday(new Date());
          const sunday = getSunday(new Date());
          filter = {
            startDate: monday.toISOString(),
            endDate: sunday.toISOString(),
            period: 'week'
          };
        } else if (period === 'month') {
          const now = new Date();
          const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
          const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          filter = {
            startDate: firstDay.toISOString(),
            endDate: lastDay.toISOString(),
            period: 'month'
          };
        } else if (period === 'custom') {
          const startDateInput = document.getElementById('salesStartDate').value;
          const endDateInput = document.getElementById('salesEndDate').value;
          
          if (!startDateInput || !endDateInput) {
            showError('Harap isi tanggal mulai dan tanggal akhir untuk periode custom.');
            return;
          }
          
          const startDate = new Date(startDateInput);
          const endDate = new Date(endDateInput);
          
          if (startDate > endDate) {
            showError('Tanggal mulai tidak boleh lebih besar dari tanggal akhir.');
            return;
          }
          
          filter = {
            startDate: startDate.toISOString(),
            endDate: endDate.toISOString(),
            period: 'custom'
          };
        }
        
        console.log('Filter created:', filter);
        showLoading('Generating Sales Report...');
        
        // Set timeout untuk mencegah loading infinite
        const timeout = setTimeout(function() {
          hideLoading();
          showError('Permintaan timeout. Silakan coba lagi atau periksa koneksi Anda.');
        }, 30000); // 30 seconds timeout
        
        google.script.run
          .withSuccessHandler(function(report) {
            clearTimeout(timeout);  
            
            if (report && report.sessionExpired) {
              SessionManager.clearSession();
              SessionManager.redirectToLogin();
              return;
            }

            console.log('=== SUCCESS HANDLER ===');
            console.log('Report received:', report);
            console.log('Report type:', typeof report);
            console.log('Report keys:', report ? Object.keys(report) : 'null');
            console.log('Report.error:', report ? report.error : 'undefined');
            console.log('Report.summary:', report ? report.summary : 'undefined');
            console.log('Report.detailTransactions:', report ? report.detailTransactions : 'undefined');
            
            // Log Debug Info
            if (report && report.debugInfo) {
              console.log('=== DEBUG INFO ===');
              console.log('Headers found:', report.debugInfo.headers);
              console.log('Raw sample row:', report.debugInfo.rawSample);
              console.log('Date parsing sample:', report.debugInfo.parsedDateSample);
              console.log('Filter range:', report.debugInfo.filterRange);
              console.log('Rows before filter:', report.debugInfo.rowCountBeforeFilter);
              console.log('Rows after filter:', report.debugInfo.rowCountAfterFilter);
              console.log('==================');
            }

            hideLoading();
            
            if (!report) {
              console.error('ERROR: Report is null or undefined');
              showError('Tidak ada data laporan yang dikembalikan dari server. Silakan coba lagi atau periksa koneksi Anda.');
              return;
            }
            
            // Check if error property exists and is true
            if (report.error === true) {
              console.error('ERROR from server:', report.message);
              showError('Error dari server: ' + (report.message || 'Unknown error'));
              return;
            }
            
            if (!report.summary) {
              console.error('ERROR: Report missing summary. Report:', JSON.stringify(report));
              showError('Format laporan tidak valid. Missing summary data.');
              return;
            }
            
            // Check if there's actual data
            if (report.summary.totalOrders === 0 && (!report.detailTransactions || report.detailTransactions.length === 0)) {
              console.log('No data in report - showing empty data message');
              
              let msg = 'Tidak ada data penjualan untuk periode yang dipilih.';
              if (report.debugInfo && report.debugInfo.dataRange && report.debugInfo.dataRange.min) {
                const minD = new Date(report.debugInfo.dataRange.min).toLocaleDateString('id-ID');
                const maxD = new Date(report.debugInfo.dataRange.max).toLocaleDateString('id-ID');
                msg += `<br><br><strong>Info Data:</strong><br>Data tersedia dari: ${minD} s/d ${maxD}`;
              }
              msg += '<br><br>Silakan pilih periode lain yang sesuai dengan data yang tersedia.';
              
              showWarning(msg);
              return;
            }
            
            console.log('SUCCESS - About to display report');
            try {
              displaySalesReport(report);
            } catch (err) {
              console.error('Error in displaySalesReport:', err);
              console.error('Error message:', err.message);
              console.error('Error stack:', err.stack);
              showError('Error displaying report: ' + err.message);
            }
          })
          .withFailureHandler(function(error) {
            clearTimeout(timeout);
            console.error('=== FAILURE HANDLER ===');
            console.error('Error object:', error);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
            hideLoading();
            showError('Error: ' + (error.message || error) + '\n\nMungkin:\n1. Sheet SalesDetails kosong atau belum ada\n2. Data belum tersimpan di Google Sheets\n3. Periksa Apps Script Logs untuk detail error');
          })
          .generateSalesReport(filter, userEmail);
      } catch (err) {
        console.error('Error in generateSalesReport:', err);
        hideLoading();
        showError('Error: ' + err.message);
      }
    }

    function generateInventoryReport() {
      const user = SessionManager.getUser();
      const userEmail = user ? user.username : null;
      const period = document.querySelector('input[name="inventoryPeriod"]:checked').value;
      let filter = null;
      
      if (period === 'all') {
        filter = {
          startDate: null,
          endDate: null,
          period: 'all'
        };
      } else if (period === 'week') {
        const monday = getMonday(new Date());
        const sunday = getSunday(new Date());
        filter = {
          startDate: monday.toISOString(),
          endDate: sunday.toISOString(),
          period: 'week'
        };
      } else if (period === 'month') {
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        filter = {
          startDate: firstDay.toISOString(),
          endDate: lastDay.toISOString(),
          period: 'month'
        };
      } else if (period === 'custom') {
        const startDateInput = document.getElementById('inventoryStartDate').value;
        const endDateInput = document.getElementById('inventoryEndDate').value;
        
        if (!startDateInput || !endDateInput) {
          showError('Harap isi tanggal mulai dan tanggal akhir untuk periode custom.');
          return;
        }
        
        const startDate = new Date(startDateInput);
        const endDate = new Date(endDateInput);
        
        if (startDate > endDate) {
          showError('Tanggal mulai tidak boleh lebih besar dari tanggal akhir.');
          return;
        }
        
        filter = {
          startDate: startDate.toISOString(),
          endDate: endDate.toISOString(),
          period: 'custom'
        };
      }
      
      showLoading('Generating Inventory Report...');
      google.script.run
        .withSuccessHandler(function(report) {
          hideLoading();
          if (report && report.sessionExpired) {
            SessionManager.clearSession();
            SessionManager.redirectToLogin();
            return;
          }
          displayInventoryReport(report);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showError('Error generating inventory report: ' + error.message);
        })
        .generateInventoryReport(filter, userEmail);
    }

    function generateFinancialReport() {
      const user = SessionManager.getUser();
      const userEmail = user ? user.username : null;
      const period = document.querySelector('input[name="financialPeriod"]:checked').value;
      let filter = null;
      
      if (period === 'all') {
        filter = {
          startDate: null,
          endDate: null,
          period: 'all'
        };
      } else if (period === 'week') {
        const monday = getMonday(new Date());
        const sunday = getSunday(new Date());
        filter = {
          startDate: monday.toISOString(),
          endDate: sunday.toISOString(),
          period: 'week'
        };
      } else if (period === 'month') {
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        filter = {
          startDate: firstDay.toISOString(),
          endDate: lastDay.toISOString(),
          period: 'month'
        };
      } else if (period === 'custom') {
        const startDateInput = document.getElementById('financialStartDate').value;
        const endDateInput = document.getElementById('financialEndDate').value;
        
        if (!startDateInput || !endDateInput) {
          showError('Harap isi tanggal mulai dan tanggal akhir untuk periode custom.');
          return;
        }
        
        const startDate = new Date(startDateInput);
        const endDate = new Date(endDateInput);
        
        if (startDate > endDate) {
          showError('Tanggal mulai tidak boleh lebih besar dari tanggal akhir.');
          return;
        }
        
        filter = {
          startDate: startDate.toISOString(),
          endDate: endDate.toISOString(),
          period: 'custom'
        };
      }
      
      showLoading('Generating Financial Report...');
      google.script.run
        .withSuccessHandler(function(report) {
          hideLoading();
          if (report && report.sessionExpired) {
            SessionManager.clearSession();
            SessionManager.redirectToLogin();
            return;
          }
          displayFinancialReport(report);
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showError('Error generating financial report: ' + error.message);
        })
        .generateFinancialReport(filter, userEmail);
    }

    function showLoading(message) {
      const modal = document.createElement('div');
      modal.id = 'loading-modal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;

      modal.innerHTML = `
        <div style="
          background: white;
          padding: 30px;
          border-radius: 10px;
          text-align: center;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        ">
          <div style="
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
          "></div>
          <p style="margin: 0; color: #2c3e50; font-weight: bold;">${message}</p>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function hideLoading() {
      const modal = document.getElementById('loading-modal');
      if (modal) modal.remove();
    }

    function showWarning(message) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;

      modal.innerHTML = `
        <div style="
          background: white;
          padding: 30px;
          border-radius: 10px;
          max-width: 400px;
          text-align: center;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        ">
          <h3 style="color: #f39c12; margin-bottom: 15px;">‚ö†Ô∏è Informasi</h3>
          <p style="color: #7f8c8d; margin-bottom: 20px; line-height: 1.6;">${message}</p>
          <button onclick="this.closest('div').parentElement.remove()" style="
            background: #f39c12;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
          ">Tutup</button>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function showError(message) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;

      modal.innerHTML = `
        <div style="
          background: white;
          padding: 30px;
          border-radius: 10px;
          max-width: 400px;
          text-align: center;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        ">
          <h3 style="color: #e74c3c; margin-bottom: 15px;">‚ùå Error</h3>
          <p style="color: #7f8c8d; margin-bottom: 20px; line-height: 1.6;">${message}</p>
          <button onclick="this.closest('div').parentElement.remove()" style="
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
          ">Close</button>
        </div>
      `;

      document.body.appendChild(modal);
    }

    // Export functions
    let currentReportData = null;
    let currentReportType = '';

    function displaySalesReport(report) {
      currentReportData = report;
      currentReportType = 'sales';
      const modal = createReportModal('Rekap Penjualan', createSalesReportHTML(report));
      document.body.appendChild(modal);
    }

    function displayInventoryReport(report) {
      currentReportData = report;
      currentReportType = 'inventory';
      const modal = createReportModal('Rekap Inventory', createInventoryReportHTML(report));
      document.body.appendChild(modal);
    }

    function displayFinancialReport(report) {
      currentReportData = report;
      currentReportType = 'financial';
      const modal = createReportModal('Rekap Keuangan', createFinancialReportHTML(report));
      document.body.appendChild(modal);
    }

    function createReportModal(title, content) {
      const modal = document.createElement('div');
      modal.id = 'reportModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        overflow-y: auto;
      `;

      modal.innerHTML = `
        <div style="
          background: white;
          border-radius: 10px;
          max-width: 90%;
          max-height: 90%;
          overflow-y: auto;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        ">
          <div style="
            padding: 20px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border-radius: 10px 10px 0 0;
          ">
            <h2 style="margin: 0; color: #2c3e50;">${title}</h2>
            <div style="display: flex; gap: 10px;">
              <button onclick="exportReportToCSV('${title}')" style="
                background: #27ae60;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
              ">üìä Export CSV</button>
              <button onclick="printReport()" style="
                background: #3498db;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
              ">üñ®Ô∏è Print</button>
              <button onclick="closeReportModal()" style="
                background: #e74c3c;
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
              ">‚úï Close</button>
            </div>
          </div>
          <div style="padding: 30px;" id="reportContent">
            ${content}
          </div>
        </div>
      `;

      // Close on click outside
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeReportModal();
        }
      });

      return modal;
    }

    function closeReportModal() {
      const modal = document.getElementById('reportModal');
      if (modal) {
        modal.remove();
      }
    }

    function createSalesReportHTML(report) {
      const formatCurrency = (amount) => 'Rp ' + Number(amount).toLocaleString('id-ID');
      const formatDate = (dateStr) => new Date(dateStr).toLocaleDateString('id-ID');

      // Format periode untuk header
      let periodHeader = '';
      if (report.summary.filterStartDate && report.summary.filterEndDate) {
        periodHeader = `<div style="text-align: center; margin-bottom: 20px; color: #7f8c8d;">
          <strong>Periode:</strong> ${formatDate(report.summary.filterStartDate)} - ${formatDate(report.summary.filterEndDate)}
        </div>`;
      }

      return `
        ${periodHeader}
        <div style="margin-bottom: 30px;">
          <h3 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">Ringkasan Penjualan</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 10px 0; color: #27ae60; font-size: 13px;">Total Penjualan</h4>
              <p style="margin: 0; font-size: 16px; font-weight: bold; color: #27ae60;">${formatCurrency(report.summary.totalSales)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 10px 0; color: #3498db; font-size: 13px;">Total Order</h4>
              <p style="margin: 0; font-size: 16px; font-weight: bold; color: #3498db;">${report.summary.totalOrders}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 10px 0; color: #9b59b6; font-size: 13px;">Item Terjual</h4>
              <p style="margin: 0; font-size: 16px; font-weight: bold; color: #9b59b6;">${report.summary.totalItems} unit</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 10px 0; color: #e67e22; font-size: 13px;">Rata-rata Order</h4>
              <p style="margin: 0; font-size: 16px; font-weight: bold; color: #e67e22;">${formatCurrency(report.summary.averageOrderValue)}</p>
            </div>
            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #c8e6c9;">
              <h4 style="margin: 0 0 10px 0; color: #2e7d32; font-size: 13px;">Stok Awal</h4>
              <p style="margin: 0; font-size: 16px; font-weight: bold; color: #2e7d32;">${report.summary.totalInitialStock || 0} unit</p>
            </div>
            <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #ffe0b2;">
              <h4 style="margin: 0 0 10px 0; color: #e65100; font-size: 13px;">Stok Sisa</h4>
              <p style="margin: 0; font-size: 16px; font-weight: bold; color: #e65100;">${report.summary.totalRemainingStock || 0} unit</p>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 30px;">
          <div>
            <h4 style="color: #2c3e50; margin-bottom: 15px;">Top 10 Item Terlaris</h4>
            <div style="max-height: 350px; overflow-y: auto;">
              ${report.topItems && report.topItems.length > 0 ? 
                report.topItems.map((item, index) =>
                  `<div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; background: ${index % 2 === 0 ? '#fff' : '#f9f9f9'};">
                    <div style="flex: 1;">
                      <div style="font-weight: bold; color: #2c3e50;">${index + 1}. ${item.itemId || 'Unknown'}</div>
                      <div style="font-size: 12px; color: #7f8c8d;">${item.itemName}</div>
                      <div style="font-size: 11px; margin-top: 2px;">
                        <span style="background: #e3f2fd; padding: 2px 6px; border-radius: 3px; color: #1976d2;">${item.itemCategory || 'Uncategorized'}</span>
                      </div>
                    </div>
                    <div style="text-align: center; padding: 0 15px;">
                      <div style="font-size: 11px; color: #7f8c8d;">Terjual</div>
                      <div style="font-weight: bold; color: #27ae60;">${item.qty} unit</div>
                      <div style="font-size: 11px; color: #7f8c8d;">${formatCurrency(item.revenue)}</div>
                    </div>
                    <div style="text-align: right; min-width: 100px;">
                      <div style="font-size: 10px; color: #2e7d32; background: #e8f5e9; padding: 2px 6px; border-radius: 3px; margin-bottom: 3px;">
                        Awal: ${item.initialQty || 0}
                      </div>
                      <div style="font-size: 10px; color: #e65100; background: #fff3e0; padding: 2px 6px; border-radius: 3px;">
                        Sisa: ${item.remainingQty || 0}
                      </div>
                    </div>
                  </div>`
                ).join('') 
                : '<p style="text-align: center; color: #7f8c8d; padding: 20px;">Tidak ada data</p>'
              }
            </div>
          </div>
        </div>

        ${report.detailTransactions && report.detailTransactions.length > 0 ? `
        <div style="margin-top: 30px;">
          <h4 style="color: #2c3e50; margin-bottom: 15px; border-bottom: 2px solid #3498db; padding-bottom: 10px;">Detail Transaksi (${report.detailTransactions.length} transaksi)</h4>
          <div style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
              <thead style="background: #f8f9fa; position: sticky; top: 0;">
                <tr>
                  <th style="padding: 10px 6px; text-align: left; border-bottom: 2px solid #ddd;">Tanggal</th>
                  <th style="padding: 10px 6px; text-align: left; border-bottom: 2px solid #ddd;">ID Pesanan</th>
                  <th style="padding: 10px 6px; text-align: left; border-bottom: 2px solid #ddd;">Item ID</th>
                  <th style="padding: 10px 6px; text-align: left; border-bottom: 2px solid #ddd;">Kategori</th>
                  <th style="padding: 10px 6px; text-align: left; border-bottom: 2px solid #ddd;">Nama Barang</th>
                  <th style="padding: 10px 6px; text-align: right; border-bottom: 2px solid #ddd;">Qty</th>
                  <th style="padding: 10px 6px; text-align: right; border-bottom: 2px solid #ddd;">Harga</th>
                  <th style="padding: 10px 6px; text-align: right; border-bottom: 2px solid #ddd;">Total</th>
                  <th style="padding: 10px 6px; text-align: left; border-bottom: 2px solid #ddd;">Pelanggan</th>
                </tr>
              </thead>
              <tbody>
                ${report.detailTransactions.map((tx, idx) =>
                  `<tr style="background: ${idx % 2 === 0 ? '#fff' : '#f9f9f9'};">
                    <td style="padding: 8px 6px; border-bottom: 1px solid #eee;">${formatDate(tx.date)}</td>
                    <td style="padding: 8px 6px; border-bottom: 1px solid #eee;">${tx.soId}</td>
                    <td style="padding: 8px 6px; border-bottom: 1px solid #eee;"><strong>${tx.itemId || '-'}</strong></td>
                    <td style="padding: 8px 6px; border-bottom: 1px solid #eee;"><span style="background: #e3f2fd; padding: 2px 6px; border-radius: 3px; font-size: 11px;">${tx.itemCategory || '-'}</span></td>
                    <td style="padding: 8px 6px; border-bottom: 1px solid #eee;">${tx.itemName}</td>
                    <td style="padding: 8px 6px; text-align: right; border-bottom: 1px solid #eee;">${tx.qty}</td>
                    <td style="padding: 8px 6px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(tx.unitPrice)}</td>
                    <td style="padding: 8px 6px; text-align: right; border-bottom: 1px solid #eee;">${formatCurrency(tx.total)}</td>
                    <td style="padding: 8px 6px; border-bottom: 1px solid #eee;">${tx.customer || '-'}</td>
                  </tr>`
                ).join('')}
              </tbody>
            </table>
          </div>
        </div>
        ` : ''}

        <div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">
          <small style="color: #7f8c8d;">Laporan dihasilkan pada: ${formatDate(report.generatedAt)}</small>
        </div>
      `;
    }

    function createInventoryReportHTML(report) {
      const formatCurrency = (amount) => 'Rp ' + Number(amount).toLocaleString('id-ID');

      return `
        <div style="margin-bottom: 30px;">
          <h3 style="color: #2c3e50; border-bottom: 2px solid #f39c12; padding-bottom: 10px;">Ringkasan Inventory</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 10px 0; color: #3498db;">Total Item</h4>
              <p style="margin: 0; font-size: 18px; font-weight: bold; color: #3498db;">${report.summary.totalItems}</p>
            </div>
            <div style="background: #e8f6e8; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #27ae60;">
              <h4 style="margin: 0 0 10px 0; color: #27ae60;">Stok Awal</h4>
              <p style="margin: 0; font-size: 18px; font-weight: bold; color: #27ae60;">${report.summary.initialStock || 0} unit</p>
            </div>
            <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #f39c12;">
              <h4 style="margin: 0 0 10px 0; color: #e67e22;">Terjual</h4>
              <p style="margin: 0; font-size: 18px; font-weight: bold; color: #e67e22;">${report.summary.totalSold || 0} unit</p>
            </div>
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #2196f3;">
              <h4 style="margin: 0 0 10px 0; color: #1976d2;">Stok Sisa</h4>
              <p style="margin: 0; font-size: 18px; font-weight: bold; color: #1976d2;">${report.summary.totalStock} unit</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 10px 0; color: #9b59b6;">Total Nilai</h4>
              <p style="margin: 0; font-size: 18px; font-weight: bold; color: #9b59b6;">${formatCurrency(report.summary.totalValue)}</p>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
              <h4 style="margin: 0 0 10px 0; color: #e74c3c;">Stok Rendah</h4>
              <p style="margin: 0; font-size: 18px; font-weight: bold; color: #e74c3c;">${report.summary.lowStockItems} item</p>
            </div>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
          <div>
            <h4 style="color: #2c3e50; margin-bottom: 15px;">Item Stok Rendah</h4>
            <div style="max-height: 300px; overflow-y: auto;">
              ${report.lowStockList && report.lowStockList.length > 0 ? 
                report.lowStockList.map(item =>
                  `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; ${item.remainingQty <= 0 ? 'background: #ffeaea;' : ''}">
                    <span>${item.itemName || 'N/A'}</span>
                    <span style="font-weight: bold; color: ${item.remainingQty <= 0 ? '#e74c3c' : '#f39c12'};">${item.remainingQty} ${item.remainingQty <= 0 ? '(Habis)' : '(< 10)'}</span>
                  </div>`
                ).join('') 
                : '<p style="text-align: center; color: #7f8c8d; padding: 20px;">Semua item stok mencukupi</p>'
              }
            </div>
          </div>

          <div>
            <h4 style="color: #2c3e50; margin-bottom: 15px;">Item Stok Terbanyak</h4>
            <div style="max-height: 300px; overflow-y: auto;">
              ${report.topSelling && report.topSelling.length > 0 ?
                report.topSelling.map((item, index) =>
                  `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <span>${index + 1}. ${item.itemName || 'N/A'}</span>
                    <span style="font-weight: bold; color: #27ae60;">${item.remainingQty} unit</span>
                  </div>`
                ).join('')
                : '<p style="text-align: center; color: #7f8c8d; padding: 20px;">Tidak ada data</p>'
              }
            </div>
          </div>
        </div>

        <div style="margin-top: 30px;">
          <h4 style="color: #2c3e50; margin-bottom: 15px; border-bottom: 2px solid #3498db; padding-bottom: 10px;">üì¶ Daftar Sisa Stok Semua Barang</h4>
          <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
              <thead style="background: #34495e; color: white; position: sticky; top: 0;">
                <tr>
                  <th style="padding: 12px 10px; text-align: left;">No</th>
                  <th style="padding: 12px 10px; text-align: left;">Kode Barang</th>
                  <th style="padding: 12px 10px; text-align: left;">Nama Barang</th>
                  <th style="padding: 12px 10px; text-align: left;">Kategori</th>
                  <th style="padding: 12px 10px; text-align: right;">Sisa Stok</th>
                  <th style="padding: 12px 10px; text-align: right;">Harga Satuan</th>
                  <th style="padding: 12px 10px; text-align: right;">Total Nilai</th>
                </tr>
              </thead>
              <tbody>
                ${report.allItems && report.allItems.length > 0 ?
                  report.allItems.map((item, index) => 
                    `<tr style="border-bottom: 1px solid #eee; ${item.remainingQty <= 0 ? 'background: #ffeaea;' : item.remainingQty < 10 ? 'background: #fff8e6;' : ''}">
                      <td style="padding: 10px;">${index + 1}</td>
                      <td style="padding: 10px;">${item.itemId || '-'}</td>
                      <td style="padding: 10px; font-weight: 500;">${item.itemName}</td>
                      <td style="padding: 10px;"><span style="background: #e8f4fd; color: #2980b9; padding: 3px 8px; border-radius: 4px; font-size: 12px;">${item.category}</span></td>
                      <td style="padding: 10px; text-align: right; font-weight: bold; color: ${item.remainingQty <= 0 ? '#e74c3c' : item.remainingQty < 10 ? '#f39c12' : '#27ae60'};">${item.remainingQty} unit</td>
                      <td style="padding: 10px; text-align: right;">${formatCurrency(item.unitPrice)}</td>
                      <td style="padding: 10px; text-align: right; font-weight: 500;">${formatCurrency(item.totalValue)}</td>
                    </tr>`
                  ).join('')
                  : '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #7f8c8d;">Tidak ada data inventory</td></tr>'
                }
              </tbody>
            </table>
          </div>
        </div>

        <div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">
          <small style="color: #7f8c8d;">Laporan dihasilkan pada: ${new Date(report.generatedAt).toLocaleDateString('id-ID')}</small>
        </div>
      `;
    }

    function createFinancialReportHTML(report) {
      const formatCurrency = (amount) => 'Rp ' + Number(amount).toLocaleString('id-ID');

      // Helper to safely get entries
      const revenueEntries = report.revenueByMonth ? Object.entries(report.revenueByMonth) : [];
      const paymentEntries = report.paymentMethods ? Object.entries(report.paymentMethods) : [];

      const cardStyle = "background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; border: 1px solid #f0f0f0;";
      const iconBoxStyle = (color) => `width: 50px; height: 50px; border-radius: 10px; background: ${color}15; display: flex; align-items: center; justify-content: center; color: ${color}; font-size: 24px;`;
      const labelStyle = "color: #7f8c8d; font-size: 13px; margin-bottom: 5px; font-weight: 500;";
      const valueStyle = (color) => `color: ${color}; font-size: 20px; font-weight: 700; margin: 0;`;

      return `
        <div style="margin-bottom: 35px;">
          <div style="display: flex; align-items: center; margin-bottom: 20px;">
             <div style="width: 4px; height: 24px; background: #27ae60; border-radius: 2px; margin-right: 10px;"></div>
             <h3 style="color: #2c3e50; margin: 0; font-size: 18px;">Ringkasan Keuangan</h3>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px;">
            <!-- Total Pendapatan -->
            <div style="${cardStyle}">
              <div style="${iconBoxStyle('#27ae60')}">
                <i class="fas fa-arrow-up"></i>
              </div>
              <div>
                <div style="${labelStyle}">Total Pendapatan</div>
                <p style="${valueStyle('#2c3e50')}">${formatCurrency(report.summary.totalRevenue)}</p>
              </div>
            </div>

            <!-- Total Pengeluaran -->
            <div style="${cardStyle}">
              <div style="${iconBoxStyle('#e74c3c')}">
                <i class="fas fa-arrow-down"></i>
              </div>
              <div>
                <div style="${labelStyle}">Total Pengeluaran</div>
                <p style="${valueStyle('#2c3e50')}">${formatCurrency(report.summary.totalPurchases)}</p>
              </div>
            </div>

            <!-- Laba Kotor -->
            <div style="${cardStyle}">
              <div style="${iconBoxStyle(report.summary.grossProfit >= 0 ? '#27ae60' : '#e74c3c')}">
                <i class="fas fa-chart-line"></i>
              </div>
              <div>
                <div style="${labelStyle}">Laba Kotor</div>
                <p style="${valueStyle(report.summary.grossProfit >= 0 ? '#27ae60' : '#e74c3c')}">${formatCurrency(report.summary.grossProfit)}</p>
              </div>
            </div>

            <!-- Arus Kas Bersih -->
            <div style="${cardStyle}">
              <div style="${iconBoxStyle('#3498db')}">
                <i class="fas fa-wallet"></i>
              </div>
              <div>
                <div style="${labelStyle}">Arus Kas Bersih</div>
                <p style="${valueStyle('#2c3e50')}">${formatCurrency(report.summary.netCashFlow)}</p>
              </div>
            </div>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px;">
          <!-- Pendapatan per Bulan -->
          <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #f0f0f0;">
            <h4 style="color: #2c3e50; margin: 0 0 20px 0; font-size: 16px; display: flex; align-items: center;">
                <i class="fas fa-calendar-alt" style="margin-right: 10px; color: #27ae60;"></i>
                Pendapatan per Bulan
            </h4>
            <div style="max-height: 300px; overflow-y: auto;">
              ${revenueEntries.length > 0 ? 
                `<table style="width: 100%; border-collapse: separate; border-spacing: 0 8px;">
                    ${revenueEntries.map(([month, amount]) =>
                    `<tr style="background: #f8f9fa; border-radius: 8px;">
                        <td style="padding: 12px 15px; color: #555; border-radius: 8px 0 0 8px;">${month}</td>
                        <td style="padding: 12px 15px; text-align: right; font-weight: bold; color: #27ae60; border-radius: 0 8px 8px 0;">${formatCurrency(amount)}</td>
                    </tr>`
                    ).join('')}
                </table>`
                : `
                <div style="text-align: center; padding: 40px 20px;">
                  <div style="width: 60px; height: 60px; background: #f5f6f7; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; color: #bdc3c7;">
                    <i class="fas fa-chart-bar" style="font-size: 24px;"></i>
                  </div>
                  <p style="color: #95a5a6; font-size: 14px; margin: 0;">Belum ada data pendapatan untuk periode ini</p>
                </div>
                `
              }
            </div>
          </div>

          <!-- Metode Pembayaran -->
          <div style="background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #f0f0f0;">
            <h4 style="color: #2c3e50; margin: 0 0 20px 0; font-size: 16px; display: flex; align-items: center;">
                <i class="fas fa-credit-card" style="margin-right: 10px; color: #3498db;"></i>
                Metode Pembayaran
            </h4>
            <div style="max-height: 300px; overflow-y: auto;">
              ${paymentEntries.length > 0 ?
                `<table style="width: 100%; border-collapse: separate; border-spacing: 0 8px;">
                    ${paymentEntries.map(([method, amount]) =>
                    `<tr style="background: #f8f9fa; border-radius: 8px;">
                        <td style="padding: 12px 15px; color: #555; border-radius: 8px 0 0 8px;">${method}</td>
                        <td style="padding: 12px 15px; text-align: right; font-weight: bold; color: #3498db; border-radius: 0 8px 8px 0;">${formatCurrency(amount)}</td>
                    </tr>`
                    ).join('')}
                </table>`
                : `
                <div style="text-align: center; padding: 40px 20px;">
                  <div style="width: 60px; height: 60px; background: #f5f6f7; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; color: #bdc3c7;">
                    <i class="fas fa-receipt" style="font-size: 24px;"></i>
                  </div>
                  <p style="color: #95a5a6; font-size: 14px; margin: 0;">Belum ada data pembayaran</p>
                </div>
                `
              }
            </div>
          </div>
        </div>

        <div style="margin-top: 30px; padding: 15px; text-align: center; border-top: 1px solid #eee;">
          <small style="color: #95a5a6;">Laporan dihasilkan pada: ${new Date(report.generatedAt).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</small>
        </div>
      `;
    }

    function exportReportToCSV(title) {
      if (!currentReportData) {
        showError('No report data available');
        return;
      }

      let csvContent = '';
      const date = new Date().toLocaleDateString('id-ID');

      switch(currentReportType) {
        case 'sales':
          csvContent = generateSalesCSV(currentReportData, date);
          break;
        case 'inventory':
          csvContent = generateInventoryCSV(currentReportData, date);
          break;
        case 'financial':
          csvContent = generateFinancialCSV(currentReportData, date);
          break;
      }

      downloadCSV(csvContent, `${title}_${new Date().getTime()}.csv`);
    }

    function generateSalesCSV(report, date) {
      const formatDate = (dateStr) => new Date(dateStr).toLocaleDateString('id-ID');
      
      let csv = `Rekap Penjualan - ${date}\n`;
      
      // Tambahkan info periode filter jika ada
      if (report.summary.filterStartDate && report.summary.filterEndDate) {
        csv += `Periode: ${formatDate(report.summary.filterStartDate)} - ${formatDate(report.summary.filterEndDate)}\n`;
      }
      
      csv += `\nSummary\n`;
      csv += `Total Sales,${report.summary.totalSales}\n`;
      csv += `Total Orders,${report.summary.totalOrders}\n`;
      csv += `Total Items,${report.summary.totalItems}\n`;
      csv += `Average Order Value,${report.summary.averageOrderValue}\n\n`;
      
      csv += `Top 10 Items\n`;
      csv += `Item ID,Item Name,Quantity Sold\n`;
      if (report.topItems && report.topItems.length > 0) {
        report.topItems.forEach(item => {
          csv += `"${item.itemId}","${item.itemName}",${item.qty}\n`;
        });
      }
      
      // Tambahkan detail transaksi
      if (report.detailTransactions && report.detailTransactions.length > 0) {
        csv += `\nDetail Transaksi (${report.detailTransactions.length} transaksi)\n`;
        csv += `Tanggal,ID Pesanan,Kode Barang,Nama Barang,Jumlah,Harga Satuan,Total,Pelanggan\n`;
        report.detailTransactions.forEach(tx => {
          csv += `${formatDate(tx.date)},"${tx.soId}","${tx.itemId}","${tx.itemName}",${tx.qty},${tx.unitPrice},${tx.total},"${tx.customer || '-'}"\n`;
        });
      }
      
      return csv;
    }

    function generateInventoryCSV(report, date) {
      let csv = `Rekap Inventory - ${date}\n\n`;
      csv += `Summary\n`;
      csv += `Total Items,${report.summary.totalItems}\n`;
      csv += `Total Stock,${report.summary.totalStock}\n`;
      csv += `Total Value,${report.summary.totalValue}\n`;
      csv += `Low Stock Items,${report.summary.lowStockItems}\n`;
      csv += `Out of Stock Items,${report.summary.outOfStockItems}\n\n`;
      
      csv += `Low Stock Items\n`;
      csv += `Item Name,Remaining QTY,Reorder Level\n`;
      report.lowStockList.forEach(item => {
        csv += `"${item.itemName}",${item.remainingQty},${item.reorderLevel}\n`;
      });
      
      return csv;
    }

    function generateFinancialCSV(report, date) {
      let csv = `Rekap Keuangan - ${date}\n\n`;
      csv += `Summary\n`;
      csv += `Total Revenue,${report.summary.totalRevenue}\n`;
      csv += `Total Purchases,${report.summary.totalPurchases}\n`;
      csv += `Gross Profit,${report.summary.grossProfit}\n`;
      csv += `Total Payments Received,${report.summary.totalPaymentsReceived}\n`;
      csv += `Net Cash Flow,${report.summary.netCashFlow}\n\n`;
      
      csv += `Revenue by Month\n`;
      csv += `Month,Revenue\n`;
      Object.entries(report.revenueByMonth).forEach(([month, revenue]) => {
        csv += `${month},${revenue}\n`;
      });
      
      return csv;
    }

    function downloadCSV(content, filename) {
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function printReport() {
      const content = document.getElementById('reportContent');
      if (!content) return;
      
      const printWindow = window.open('', '', 'width=800,height=600');
      printWindow.document.write('<html><head><title>Print Report</title>');
      printWindow.document.write('<style>');
      printWindow.document.write('body { font-family: Arial, sans-serif; padding: 20px; }');
      printWindow.document.write('table { width: 100%; border-collapse: collapse; margin: 20px 0; }');
      printWindow.document.write('th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }');
      printWindow.document.write('th { background-color: #f2f2f2; }');
      printWindow.document.write('@media print { button { display: none; } }');
      printWindow.document.write('</style></head><body>');
      printWindow.document.write(content.innerHTML);
      printWindow.document.write('</body></html>');
      printWindow.document.close();
      printWindow.print();
    }
  </script>

<!-- End Reports Page Fragment -->