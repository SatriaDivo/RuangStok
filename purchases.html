  <!-- Flatpickr (Date Picker) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  
  <style>
    :root {
      --primary: #1abc9c;
      --primary-light: #d1f2eb;
      --primary-dark: #16a085;
      --secondary: #3498db;
      --dark: #2c3e50;
      --light-dark: #34495e;
      --gray: #7f8c8d;
      --light-gray: #ecf0f1;
      --white: #ffffff;
      --error: #e74c3c;
      --warning: #f39c12;
      --success: #2ecc71;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f8f9fa;
      color: var(--light-dark);
    }
    
    .purchase-container {
      max-width: 1400px;
      margin: 0 auto;
      background-color: var(--white);
      border-radius: 8px;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
      padding: 25px;
    }
    
    .header-section {
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .header-section h1 {
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 8px;
    }
    
    .header-section p {
      color: var(--gray);
      font-size: 1.05rem;
    }
    
    .action-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: var(--white);
    }
    
    .btn-primary:hover {
      background-color: var(--primary-dark);
    }
    
    .btn-secondary {
      background-color: var(--secondary);
      color: var(--white);
    }
    
    .btn-secondary:hover {
      background-color: #2980b9;
    }
    
    .btn-outline {
      background-color: transparent;
      border: 1px solid #bdc3c7;
      color: var(--light-dark);
    }
    
    .btn-outline:hover {
      background-color: var(--light-gray);
    }
    
    .search-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .search-select {
      padding: 9px;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      background-color: var(--white);
      min-width: 160px;
    }
    
    .search-input {
      padding: 10px;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      width: 250px;
    }
    
    .purchase-table {
      width: 100%;
      border-collapse: collapse;
      background-color: var(--white);
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    
    .purchase-table th {
      background-color: var(--dark);
      color: var(--white);
      padding: 14px 16px;
      text-align: left;
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
      font-size: 0.95rem;
    }
    
    .purchase-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--light-gray);
      color: var(--light-dark);
      font-size: 0.92rem;
    }
    
    .purchase-table tr:hover {
      background-color: rgba(26, 188, 156, 0.05);
    }
    
    /* Responsive Styles */
    @media screen and (max-width: 1024px) {
      .purchase-container {
        padding: 20px;
      }
      
      .action-bar {
        flex-direction: column;
      }
      
      .search-group {
        width: 100%;
        flex-direction: column;
      }
      
      .search-select,
      .search-input {
        width: 100%;
      }
    }
    
    @media screen and (max-width: 768px) {
      .purchase-container {
        padding: 15px;
        border-radius: 0;
      }
      
      .header-section h1 {
        font-size: 1.5rem;
      }
      
      .btn-group {
        width: 100%;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
      
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .purchase-table {
        min-width: 1000px;
      }
      
      .purchase-table th,
      .purchase-table td {
        padding: 10px 8px;
        font-size: 0.85rem;
      }
      
      .modal-content {
        width: 95%;
        max-width: 95%;
        max-height: 90vh;
        margin: 10px auto;
        padding: 20px;
      }
      
      #poDetailsModal .items-table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      #poDetailsModal .items-table {
        min-width: 1200px;
        font-size: 12px;
      }
      
      #poDetailsModal .items-table th,
      #poDetailsModal .items-table td {
        padding: 6px 4px;
        font-size: 11px;
      }
      
      .form-grid {
        grid-template-columns: 1fr !important;
      }
    }
    
    @media screen and (max-width: 480px) {
      .header-section h1 {
        font-size: 1.25rem;
      }
      
      .header-section p {
        font-size: 0.9rem;
      }
      
      .btn {
        padding: 8px 12px;
        font-size: 0.85rem;
      }
      
      .purchase-table {
        font-size: 0.8rem;
      }
      
      .action-btn {
        padding: 4px 8px;
        font-size: 0.75rem;
      }
    }
    
    .action-cell {
      display: flex;
      gap: 8px;
    }
    
    .action-btn {
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .view-btn {
      background-color: #3498db;
      color: white;
      border: none;
    }
    
    .edit-btn {
      background-color: #f39c12;
      color: white;
      border: none;
    }
    
    .update-btn {
      background-color: var(--success);
      color: white;
      border: none;
    }
    
    .cancel-btn {
      background-color: var(--gray);
      color: white;
      border: none;
    }
    
    .edit-btn {
      background-color: #3498db;
      color: white;
      border: none;
    }
    
    .edit-btn:hover {
      background-color: #2980b9;
    }
    
    .save-btn {
      background-color: var(--success);
      color: white;
      border: none;
    }
    
    .save-btn:hover {
      background-color: #27ae60;
    }
    
    .delete-btn {
      background-color: var(--error);
      color: white;
      border: none;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      overflow: auto;
    }
    
    .modal-content {
      background-color: var(--white);
      margin: 20px auto;
      padding: 30px;
      border-radius: 8px;
      width: 95%;
      max-width: 1400px;
      max-height: 90vh;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      overflow-y: auto;
      overflow-x: hidden;
      position: relative;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .modal-header h2 {
      font-family: 'Montserrat', sans-serif;
      color: var(--dark);
      font-size: 1.6rem;
      margin: 0;
    }
    
    .close-btn {
      font-size: 1.8rem;
      cursor: pointer;
      color: var(--gray);
      transition: color 0.3s;
    }
    
    .close-btn:hover {
      color: var(--dark);
    }
    
    .form-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid var(--light-gray);
      border-radius: 6px;
      background-color: #fafafa;
    }
    
    .form-section h3 {
      font-family: 'Montserrat', sans-serif;
      color: var(--dark);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark);
      font-size: 0.95rem;
    }
    
    .form-control {
      width: 100%;
      padding: 11px;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      font-family: 'Roboto', sans-serif;
      font-size: 0.95rem;
    }
    
    .form-control:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.2);
    }
    
    .required:after {
      content: " *";
      color: var(--error);
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 25px;
      padding-top: 15px;
      border-top: 1px solid var(--light-gray);
    }
    
    .processing-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.85);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .select2-container {
      width: 100% !important;
    }
    
    .id-generate {
      display: flex;
      gap: 10px;
    }
    
    .id-field {
      flex: 1;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 25px;
      gap: 6px;
    }
    
    .page-btn {
      padding: 8px 14px;
      background-color: var(--white);
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Roboto', sans-serif;
      transition: all 0.3s;
    }
    
    .page-btn:hover:not(.active) {
      background-color: var(--light-gray);
    }
    
    .page-btn.active {
      background-color: var(--primary);
      color: var(--white);
      border-color: var(--primary);
    }
    
    .no-data-container {
      text-align: center;
      padding: 50px 20px;
      background: var(--white);
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-top: 20px;
    }
    
    .no-data-icon {
      font-size: 3.5rem;
      color: #bdc3c7;
      margin-bottom: 20px;
    }
    
    .no-data-title {
      color: var(--gray);
      margin-bottom: 10px;
      font-family: 'Montserrat', sans-serif;
    }
    
    .items-table {
      width: max-content;        /* Allows table to grow with content */
      table-layout: auto;        /* Let browser decide column width */
      border-collapse: collapse;
    }
    
    .items-table th, .items-table td {
      padding: 8px 12px;
      white-space: nowrap;   /* Prevent text from wrapping */
    }

    .items-table input, .items-table select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    .items-table input:focus, .items-table select:focus {
      border-color: var(--primary);
      outline: none;
    }
    
    .items-table .readonly {
      background-color: #f9f9f9;
      border: 1px solid #e0e0e0;
      padding: 8px;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    
    .items-table-container {
      width: 100%;
      overflow-x: auto;
      overflow-y: visible;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-top: 15px;
      margin-bottom: 20px;
      -webkit-overflow-scrolling: touch;
    }
    
    /* Ensure table inside container doesn't create extra scrollbars */
    .items-table-container .items-table {
      min-width: 100%;
      width: max-content;
      margin: 0;
      border: none;
    }
    
    .add-item-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 15px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-top: 10px;
    }
    
    .remove-item-btn {
      background: none;
      border: none;
      color: var(--error);
      cursor: pointer;
      font-size: 1.2rem;
    }
    
    .totals-row {
      font-weight: bold;
      background-color: #f5f5f5;
    }
    
    .editable {
      background-color: #fffde7;
      border: 1px solid #ffd54f;
    }
    
    /* PO Details Modal - Specific Fixes */
    #poDetailsModal .modal-content {
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px;
    }
    
    #poDetailsModal .form-section {
      width: 100%;
      overflow: visible;
    }
    
    #poDetailsModal .items-table-container {
      width: 100%;
      max-width: 100%;
      overflow-x: auto;
      overflow-y: visible;
    }
    
    #poDetailsModal .items-table {
      width: auto;
      min-width: 100%;
      table-layout: auto;
    }
    
    #poDetailsModal .items-table th,
    #poDetailsModal .items-table td {
      white-space: nowrap;
      padding: 10px 8px;
      font-size: 0.85rem;
    }
    
    /* Custom Alert Modal Styles */
    .alert-modal {
      display: none;
      position: fixed;
      z-index: 3000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      align-items: center;
      justify-content: center;
    }

    .alert-modal.show {
      display: flex;
    }

    .alert-content {
      background-color: var(--white);
      padding: 30px;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
      text-align: center;
    }

    .alert-icon {
      font-size: 3rem;
      margin-bottom: 15px;
    }

    .alert-icon.info { color: #3498db; }
    .alert-icon.success { color: #2ecc71; }
    .alert-icon.warning { color: #f39c12; }
    .alert-icon.error { color: #e74c3c; }

    .alert-title {
      font-family: 'Montserrat', sans-serif;
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 10px;
    }

    .alert-message {
      color: var(--gray);
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .alert-btn {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 10px 25px;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
      transition: background-color 0.3s;
    }

    .alert-btn:hover {
      background-color: var(--primary-dark);
    }

    @media (max-width: 900px) {
      .action-bar {
        flex-direction: column;
      }
      
      .btn-group {
        width: 100%;
        justify-content: center;
      }
      
      .search-group {
        width: 100%;
        justify-content: center;
      }
      
      .modal-content {
        width: 98%;
        padding: 15px;
      }
    }
  </style>

  <div class="purchase-container">
    <!-- Header Section -->
    <div class="header-section">
      <h1>Purchase Orders</h1>
      <p>Create and manage your purchase orders</p>
    </div>
    
    <!-- Action Bar -->
    <div class="action-bar">
      <div class="btn-group">
        <button class="btn btn-primary" onclick="poOpenNewPOModal()">
          <i class="fas fa-file-invoice"></i> New PO
        </button>
      </div>
      
      <div class="search-group">
        <select id="poSearchCriteria" class="search-select">
          <option value="all">All</option>
          <option value="PO ID">PO ID</option>
          <option value="Supplier Name">Supplier Name</option>
        </select>
        <input type="text" id="poSearchInput" class="search-input" placeholder="Search...">
        <button class="btn btn-outline" onclick="poSearchPOs()">
          <i class="fas fa-search"></i> Search
        </button>
        <button class="btn btn-outline" onclick="poClearSearch()">
          <i class="fas fa-times"></i> Clear
        </button>
      </div>
    </div>
    
    <!-- Purchase Orders Table -->
    <div class="table-container" id="poTableContainer">
      <table class="purchase-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>PO ID</th>
            <th>Supplier ID</th>
            <th>Supplier Name</th>
            <th>State</th>
            <th>City</th>
            <th>Total Amount</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="poTableBody">
          <!-- Data will be populated by JavaScript -->
        </tbody>
      </table>
      
      <!-- Pagination -->
      <div class="pagination" id="poPagination">
        <!-- Pagination buttons will be added here -->
      </div>
    </div>
    
    <!-- No Data Message -->
    <div id="poNoData" class="no-data-container" style="display:none;">
      <i class="fas fa-inbox no-data-icon"></i>
      <h3 class="no-data-title">No purchase orders found</h3>
      <p>Click "New PO" to create your first purchase order</p>
    </div>
  </div>
  
  <!-- New PO Modal -->
  <div id="poNewPOModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create New PO</h2>
        <span class="close-btn" onclick="poCloseNewPOModal()">&times;</span>
      </div>
      
      <!-- Section 1: PO Header -->
      <div class="form-section">
        <h3>PO Information</h3>
        <div class="form-grid">
          <div class="form-group">
            <label class="required">PO ID</label>
            <div class="id-generate">
              <input type="text" id="poPOID" class="form-control id-field" readonly>
              <button class="btn btn-secondary" onclick="poGeneratePOID()">Generate</button>
            </div>
          </div>
          
          <div class="form-group">
            <label class="required">PO Date</label>
            <input type="text" id="poPODate" class="form-control date-picker" placeholder="Select date">
          </div>
          
          <div class="form-group">
            <label class="required">Supplier Name</label>
            <select id="poSupplierName" class="form-control" style="width:100%" onchange="poSupplierChanged()"></select>
          </div>
          
          <div class="form-group">
            <label class="required">Supplier ID</label>
            <input type="text" id="poSupplierID" class="form-control" readonly>
          </div>
          
          <div class="form-group">
            <label class="required">State</label>
            <input type="text" id="poState" class="form-control" readonly>
          </div>
          
          <div class="form-group">
            <label class="required">City</label>
            <input type="text" id="poCity" class="form-control" readonly>
          </div>
        </div>
      </div>
      
      <!-- Section 2: PO Items -->
      <div class="form-section">
        <h3>PO Items</h3>
        <button class="add-item-btn" onclick="poAddItemRow()">
          <i class="fas fa-plus"></i> Add Item
        </button>
        
        <div class="items-table-container">
          <table class="items-table" style="table-layout: auto; width: max-content;">
            <thead>
              <tr>
                <th>Date</th>
                <th>PO ID</th>
                <th>Detail ID</th>
                <th>Supplier ID</th>
                <th>Supplier Name</th>
                <th>State</th>
                <th>City</th>
                <th>Kode Barang</th>
                <th>Nama Barang</th>
                <th>Kategori Barang</th>
                <th>Jumlah Barang</th>
                <th>Satuan Barang</th>
                <th>Total Harga</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="poItemsTableBody">
              <!-- Item rows will be added here -->
            </tbody>
          </table>
        </div>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="poCloseNewPOModal()">Close</button>
        <button class="btn btn-primary" onclick="poSaveNewPO()">Save PO</button>
      </div>
    </div>
  </div>
  
  <!-- Custom Alert Modal -->
  <div id="poAlertModal" class="alert-modal">
    <div class="alert-content">
      <div class="alert-icon" id="poAlertIcon"></div>
      <div class="alert-title" id="poAlertTitle"></div>
      <div class="alert-message" id="poAlertMessage"></div>
      <button class="alert-btn" onclick="poCloseAlert()">OK</button>
    </div>
  </div>

  <!-- PO Details Modal -->
  <div id="poDetailsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>PO Details</h2>
        <span class="close-btn" onclick="poCloseDetailsModal()">&times;</span>
      </div>
      
      <div id="poDetailsContent">
        <!-- PO details will be loaded here -->
      </div>
    </div>
  </div>
  
  <!-- Processing Overlay -->
  <div id="poProcessingOverlay" class="processing-overlay">
    <div class="spinner"></div>
    <p>Processing...</p>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
        // Global variables (no change, just for context)
    let poCurrentPage = 1;
    const poPageSize = 10;
    let poAllPOs = [];
    let poFilteredPOs = [];
    let poSuppliers = [];
    let poItems = [];
    let poDetailCounter = 1; // This counter is not strictly needed if detailId is randomly generated
    let poIsSubmitting = false; // Prevent spam submissions
    let poLastLoadTime = 0; // Rate limiting for data loads
    const poLoadMinInterval = 1000; // Minimum 1 second between loads
    
    // Get user from session
    const userStr = localStorage.getItem('ruangstok_user') || sessionStorage.getItem('ruangstok_user');
    const user = userStr ? JSON.parse(userStr) : null;

    // Initialize page
      // Initialize date picker
      flatpickr("#poPODate", {
        dateFormat: "Y-m-d", // Format for internal use and saving to sheet
        defaultDate: "today"
      });

      // Load initial data
      poLoadSuppliers();
      poLoadInventoryItems();
      poLoadPOs();

    // Rate limiting helper
    function poCanLoad() {
      const now = Date.now();
      if (now - poLastLoadTime < poLoadMinInterval) {
        return false;
      }
      poLastLoadTime = now;
      return true;
    }

    // Load suppliers (no change, just for context)
    function poLoadSuppliers() {
      google.script.run
        .withSuccessHandler(function(suppliers) {
          console.log("Loaded suppliers:", suppliers); // DEBUG
          poSuppliers = suppliers;
          const supplierSelect = $('#poSupplierName');
          supplierSelect.empty();

          poSuppliers.forEach(supplier => {
            if (supplier.name) {
              supplierSelect.append(new Option(supplier.name, supplier.id));
            }
          });

          supplierSelect.select2();
        })
        .withFailureHandler(function(error) {
          console.error("Error loading suppliers:", error);
        })
        .poGetSuppliers(user.username);
    }

    // Load inventory items (no change, just for context)
    function poLoadInventoryItems() {
      google.script.run
        .withSuccessHandler(function(items) {
          console.log("Loaded items:", items);
          if (!items || items.length === 0) {
            console.warn("poLoadInventoryItems: No items returned from backend");
            poShowAlert('Warning: No inventory items found. Please add items to InventoryItems sheet.', 'warning');
            poItems = [];
            return;
          }
          // Filter out items without valid ID
          poItems = items.filter(item => item.id && item.id !== '');
          console.log("Valid items after filter:", poItems);
          if (poItems.length === 0) {
            poShowAlert('Warning: No valid items found in inventory.', 'warning');
          }
        })
        .withFailureHandler(function(error) {
          console.error("Error loading inventory items:", error);
          poShowAlert('Error loading inventory items: ' + error.message, 'error');
          poItems = [];
        })
        .poGetInventoryItems(user.username);
    }

    // Load PMT statuses (no change, just for context)
    // Load purchase orders
    // Fix (ii): Added console.log to inspect fetched POs.
    function poLoadPOs() {
      poShowProcessing();
      google.script.run
        .withSuccessHandler(function(pos) {
          console.log("Fetched POs:", pos);
          // Filter out any invalid POs (must have valid id)
          poAllPOs = pos.filter(po => po.id && po.id !== '');
          poFilteredPOs = [...poAllPOs];
          poRenderPOTable();
          poHideProcessing();
        })
        .withFailureHandler(function(error) {
            poHideProcessing();
            console.error("Error loading POs:", error);
        })
        .poGetPOs(user.username);
    }

    // Render PO table
    // Fix (ii): Ensured date formatting for display.
    function poRenderPOTable() {
      const startIndex = (poCurrentPage - 1) * poPageSize;
      const endIndex = startIndex + poPageSize;
      const pagePOs = poFilteredPOs.slice(startIndex, endIndex);
      const tableBody = document.getElementById('poTableBody');

      tableBody.innerHTML = '';

      if (pagePOs.length === 0) {
        document.getElementById('poTableContainer').style.display = 'none';
        document.getElementById('poNoData').style.display = 'block';
        document.getElementById('poPagination').innerHTML = '';
        return;
      }

      document.getElementById('poTableContainer').style.display = 'block';
      document.getElementById('poNoData').style.display = 'none';

      pagePOs.forEach((po, index) => {
        // Format date for display
        const formattedDate = po.date instanceof Date ?
                              po.date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) :
                              po.date || ''; // Use existing value if not a Date object or empty

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${formattedDate}</td>
          <td>${po.id || ''}</td>
          <td>${po.supplierId || ''}</td>
          <td>${po.supplierName || ''}</td>
          <td>${po.state || ''}</td>
          <td>${po.city || ''}</td>
          <td>${po.totalAmount ? po.totalAmount.toFixed(2) : '0.00'}</td>
          <td class="action-cell">
            <button class="action-btn view-btn" onclick="poViewPODetails('${po.id}')">
              <i class="fas fa-eye"></i> View
            </button>
          </td>
        `;
        tableBody.appendChild(row);
      });

      // Render pagination
      poRenderPagination();
    }

    // Render pagination (no change, just for context)
    function poRenderPagination() {
      const totalPages = Math.ceil(poFilteredPOs.length / poPageSize);
      const paginationDiv = document.getElementById('poPagination');
      paginationDiv.innerHTML = '';

      if (totalPages <= 1) return;

      // Previous button
      const prevBtn = document.createElement('button');
      prevBtn.className = 'page-btn';
      prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
      prevBtn.disabled = poCurrentPage === 1;
      prevBtn.onclick = () => {
        if (poCurrentPage > 1) {
          poCurrentPage--;
          poRenderPOTable();
        }
      };
      paginationDiv.appendChild(prevBtn);

      // Page buttons
      for (let i = 1; i <= totalPages; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `page-btn ${i === poCurrentPage ? 'active' : ''}`;
        pageBtn.textContent = i;
        pageBtn.onclick = () => {
          poCurrentPage = i;
          poRenderPOTable();
        };
        paginationDiv.appendChild(pageBtn);
      }

      // Next button
      const nextBtn = document.createElement('button');
      nextBtn.className = 'page-btn';
      nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
      nextBtn.disabled = poCurrentPage === totalPages;
      nextBtn.onclick = () => {
        if (poCurrentPage < totalPages) {
          poCurrentPage++;
          poRenderPOTable();
        }
      };
      paginationDiv.appendChild(nextBtn);
    }

    // Open PMT Status modal (no change, just for context)
    // Open New PO modal (no change, just for context)
    function poOpenNewPOModal() {
      document.getElementById('poNewPOModal').style.display = 'block';
      document.getElementById('poPOID').value = '';
      document.getElementById('poPODate').value = '';
      document.getElementById('poSupplierID').value = '';
      document.getElementById('poState').value = '';
      document.getElementById('poCity').value = '';
      $('#poSupplierName').val(null).trigger('change');
      document.getElementById('poItemsTableBody').innerHTML = '';
      poDetailCounter = 1; // Reset counter for new PO
    }

    // Close New PO modal (no change, just for context)
    function poCloseNewPOModal() {
      document.getElementById('poNewPOModal').style.display = 'none';
    }

    // Generate PO ID (no change, just for context)
    function poGeneratePOID() {
      // Prevent spam generations
      if (poIsSubmitting) {
        poShowAlert('Please wait - ID generation in progress...', 'warning');
        return;
      }
      
      poIsSubmitting = true;
      poShowProcessing();
      google.script.run
        .withSuccessHandler(function(newId) {
          poIsSubmitting = false;
          document.getElementById('poPOID').value = newId;
          poHideProcessing();
        })
        .withFailureHandler(function(error) {
            poIsSubmitting = false;
            poHideProcessing();
            console.error("Error generating PO ID:", error);
            poShowAlert("Error generating PO ID: " + error.message, 'error');
        })
        .poGeneratePOID(user.username);
    }

    // Supplier changed handler (no change, just for context)
    function poSupplierChanged() {
      const supplierId = $('#poSupplierName').val();
      if (!supplierId) return;

      const supplier = poSuppliers.find(s => s.id === supplierId);
      if (supplier) {
        document.getElementById('poSupplierID').value = supplier.id;
        document.getElementById('poState').value = supplier.state;
        document.getElementById('poCity').value = supplier.city;

        // Update any existing item rows
        const rows = document.querySelectorAll('#poItemsTableBody tr');
        rows.forEach(row => {
          // Ensure these cells exist and are meant to be updated
          if (row.cells[3]) row.cells[3].textContent = supplier.id; // Supplier ID
          if (row.cells[4]) row.cells[4].textContent = supplier.name; // Supplier Name
          if (row.cells[5]) row.cells[5].textContent = supplier.state; // State
          if (row.cells[6]) row.cells[6].textContent = supplier.city; // City
          // Bill Num is from the main form, not supplier data, so keep original logic
          // row.cells[7].textContent = document.getElementById('poBillNum').value; // Bill Num
        });
      }
    }

    // Add item row (no change, just for context)
    function poAddItemRow() {
      // Check if items data is loaded
      if (!poItems || poItems.length === 0) {
        poShowAlert('Please wait - inventory items are still loading...', 'warning');
        console.warn("poAddItemRow: poItems is empty or not loaded yet. poItems =", poItems);
        return;
      }

      const poId = document.getElementById('poPOID').value;
      const poDate = document.getElementById('poPODate').value;
      const supplierId = document.getElementById('poSupplierID').value;
      const supplierName = $('#poSupplierName option:selected').text();
      const state = document.getElementById('poState').value;
      const city = document.getElementById('poCity').value;

      if (!poId) {
        poShowAlert('Please generate a PO ID first', 'warning');
        return;
      }

      if (!supplierId) {
        poShowAlert('Please select a supplier first', 'warning');
        return;
      }

      // Generate a unique detail ID
      const detailId = `D${Math.floor(10000 + Math.random() * 90000)}`;
      const tableBody = document.getElementById('poItemsTableBody');

      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="readonly">${poDate}</td>
        <td class="readonly">${poId}</td>
        <td class="readonly">${detailId}</td>
        <td class="readonly">${supplierId}</td>
        <td class="readonly">${supplierName}</td>
        <td class="readonly">${state}</td>
        <td class="readonly">${city}</td>
        <td><span class="item-id"></span></td>
        <td>
          <select class="item-select" onchange="poItemChanged(this)">
            <option value="">Select Item</option>
            ${poItems.map(item => {
              const displayText = item.name && item.name !== '' ? `${item.id} - ${item.name}` : item.id;
              return `<option value="${item.id}">${displayText}</option>`;
            }).join('')}
          </select>
        </td>
        <td><span class="item-category"></span></td>
        <td><input type="number" min="1" class="qty-purchased"></td>
        <td><input type="text" class="unit-type" placeholder="kg, lusin, ball, dll"></td>
        <td><input type="number" min="0" step="0.01" class="total-price" placeholder="0.00"></td>
        <td><button class="remove-item-btn" onclick="poRemoveItemRow(this)"><i class="fas fa-times"></i></button></td>
      `;

      tableBody.appendChild(row);
      // poDetailCounter++; // Not needed if detailId is randomly generated
    }

    // Item changed handler
    function poItemChanged(select) {
      const row = select.closest('tr');
      const itemId = select.value;

      if (!itemId) {
        row.querySelector('.item-id').textContent = '';
        row.querySelector('.item-category').textContent = '';
        return;
      }

      const item = poItems.find(i => i.id === itemId);
      if (item) {
        row.querySelector('.item-id').textContent = item.id;
        row.querySelector('.item-category').textContent = item.category;
      }

      // Item selection complete
    }

    // Remove item row
    function poRemoveItemRow(button) {
      const row = button.closest('tr');
      row.remove();
    }

    // Save new PO
    // Fix (i): Changed how itemName is retrieved to avoid querySelector error.
    // Fix (iii): Added withFailureHandler to ensure processing overlay is hidden on error.
    function poSaveNewPO() {
      console.log('poSaveNewPO() called');
      
      // Prevent spam/multiple submissions
      if (poIsSubmitting) {
        poShowAlert('Please wait - submission in progress...', 'warning');
        return;
      }

      const poId = document.getElementById('poPOID').value;
      const poDate = document.getElementById('poPODate').value;
      const supplierId = document.getElementById('poSupplierID').value;

      if (!poId) {
        poShowAlert('Please generate a PO ID', 'warning');
        return;
      }

      if (!poDate) {
        poShowAlert('Please select a PO date', 'warning');
        return;
      }

      if (!supplierId) {
        poShowAlert('Please select a supplier', 'warning');
        return;
      }

      const items = [];
      const rows = document.querySelectorAll('#poItemsTableBody tr');

      if (rows.length === 0) {
        poShowAlert('Please add at least one item to the PO', 'warning');
        return;
      }

      let isValid = true;

      rows.forEach(row => {
        const itemSelectElement = row.querySelector('.item-select');
        const itemId = row.querySelector('.item-id').textContent;
        const qty = parseFloat(row.querySelector('.qty-purchased').value) || 0;
        const unitType = row.querySelector('.unit-type').value.trim();

        if (!itemId) {
          isValid = false;
          poShowAlert('Please select an item for all rows', 'warning');
          return;
        }

        if (qty <= 0) {
          isValid = false;
          poShowAlert('Please enter a valid quantity for all items', 'warning');
          return;
        }

        if (!unitType) {
          isValid = false;
          poShowAlert('Please enter unit type (satuan barang) for all items', 'warning');
          return;
        }

        // Fix (i) - More robust way to get selected item name
        const selectedItemName = itemSelectElement && itemSelectElement.selectedIndex !== -1
                                 ? itemSelectElement.options[itemSelectElement.selectedIndex].textContent
                                 : '';

        const item = {
          date: row.cells[0].textContent,
          poId: row.cells[1].textContent,
          detailId: row.cells[2].textContent,
          supplierId: row.cells[3].textContent,
          supplierName: row.cells[4].textContent,
          state: row.cells[5].textContent,
          city: row.cells[6].textContent,
          itemId: itemId,
          itemCategory: row.cells[9].textContent,
          itemName: selectedItemName,
          qtyPurchased: qty,
          unitType: unitType,
          totalPrice: parseFloat(row.querySelector('.total-price').value) || 0
        };

        items.push(item);
      });

      if (!isValid) return;

      // Save PO to Google Sheets
      console.log('Saving PO with items:', items);
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('Save PO success:', result);
          poShowAlert('PO berhasil ditambahkan!', 'success');
          poCloseNewPOModal();
          poLoadPOs(); // Reload PO data instead of full page refresh
        })
        .withFailureHandler(function(error) {
          console.error("Error saving PO:", error);
          poShowAlert("Error saving PO: " + (error.message || error), 'error');
        })
        .poSaveNewPO(items, user.username);
    }

    // View PO details (no change, just for context)
    function poViewPODetails(poId) {
  console.log('poViewPODetails called with poId:', poId);
  poShowProcessing();
  google.script.run
    .withSuccessHandler(function(details) {
      console.log('PO Details received:', details);
      poHideProcessing();
      
      if (!details || details.length === 0) {
        poShowAlert('No details found for this PO', 'warning');
        return;
      }
      
      let html = `
        <div class="form-section">
          <h3>PO Details: ${poId}</h3>
          <div class="items-table-container">
            <table id="poDetailsTable" class="items-table">
              <thead>
                <tr>
                  <th>Date</th><th>PO ID</th><th>Detail ID</th>
                  <th>Supplier ID</th><th>Supplier Name</th><th>State</th>
                  <th>City</th>
                  <th>Kode Barang</th><th>Nama Barang</th><th>Kategori Barang</th>
                  <th>Jumlah Barang</th><th>Satuan Barang</th>
                  <th>Total Harga</th><th>Actions</th>
                </tr>
              </thead>
              <tbody>
      `;
      details.forEach(detail => {
        const d = (detail.date instanceof Date)
          ? detail.date.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'})
          : detail.date||'';
        html += `
          <tr data-detail-id="${detail.detailId}">
            <td>${d}</td>
            <td>${detail.poId}</td>
            <td>${detail.detailId}</td>
            <td>${detail.supplierId}</td>
            <td>${detail.supplierName}</td>
            <td>${detail.state}</td>
            <td>${detail.city}</td>
            <td class="item-id">${detail.itemId}</td>
            <td class="item-name">${detail.itemName}</td>
            <td class="item-category">${detail.itemCategory}</td>
            <td class="qty-purchased">${detail.qtyPurchased}</td>
            <td class="unit-type">${detail.unitType || ''}</td>
            <td class="total-price">${detail.totalPrice ? detail.totalPrice.toFixed(2) : '0.00'}</td>
            <td class="actions-cell">
              <button class="action-btn delete-btn"
                      onclick="poDeleteDetail('${detail.detailId}')"
                      title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      });
      html += `
              </tbody>
            </table>
          </div>
          <div class="modal-footer" style="text-align:right; margin-top:10px;">
            <button id="poEditAllBtn" class="btn" onclick="poEnableEditMode()">Edit</button>
            <button id="poSaveAllBtn" class="btn" style="display:none" onclick="poSavePODetails()">Update</button>
            <button id="poCancelAllBtn" class="btn" style="display:none" onclick="poCancelEditMode()">Cancel</button>
          </div>
        </div>
      `;
      document.getElementById('poDetailsContent').innerHTML = html;
      document.getElementById('poDetailsModal').style.display = 'block';
    })
    .withFailureHandler(function(err){
      console.error('Error loading PO details:', err);
      poHideProcessing();
      poShowAlert("Error loading PO details: " + (err && err.message ? err.message : err || 'Unknown error'), 'error');
    })
    .poGetPODetails(poId, user.username);
}

    // Close PO details modal (no change, just for context)
    function poCloseDetailsModal() {
      document.getElementById('poDetailsModal').style.display = 'none';
    }

    // Search POs (no change, just for context)
    function poSearchPOs() {
      const criteria = document.getElementById('poSearchCriteria').value;
      const query = document.getElementById('poSearchInput').value.toLowerCase().trim();

      if (!query) {
        poFilteredPOs = [...poAllPOs];
      } else {
        poFilteredPOs = poAllPOs.filter(po => {
          if (criteria === 'all') {
            return (
              (po.id && po.id.toLowerCase().includes(query)) ||
              (po.supplierName && po.supplierName.toLowerCase().includes(query))
            );
          } else if (criteria === 'PO ID') {
            return po.id && po.id.toLowerCase().includes(query);
          } else if (criteria === 'Supplier Name') {
            return po.supplierName && po.supplierName.toLowerCase().includes(query);
          }
          return true;
        });
      }

      poCurrentPage = 1;
      poRenderPOTable();

      if (poFilteredPOs.length === 0) {
        poShowAlert('No matching data found', 'info');
      }
    }

    // Clear search (no change, just for context)
    function poClearSearch() {
      document.getElementById('poSearchInput').value = '';
      document.getElementById('poSearchCriteria').value = 'all';
      poFilteredPOs = [...poAllPOs];
      poCurrentPage = 1;
      poRenderPOTable();
    }

    // Show processing overlay (no change, just for context)
    function poShowProcessing() {
      document.getElementById('poProcessingOverlay').style.display = 'flex';
    }

    // Hide processing overlay
    function poHideProcessing() {
      document.getElementById('poProcessingOverlay').style.display = 'none';
    }

    // Custom Alert Modal Functions
    function poShowAlert(message, type = 'info', shouldReload = false) {
      const modal = document.getElementById('poAlertModal');
      const icon = document.getElementById('poAlertIcon');
      const title = document.getElementById('poAlertTitle');
      const messageEl = document.getElementById('poAlertMessage');

      // Store reload flag in modal's dataset
      modal.dataset.shouldReload = shouldReload;

      // Set icon and title based on type
      let iconClass = '';
      let titleText = '';
      switch(type) {
        case 'success':
          iconClass = 'fas fa-check-circle';
          titleText = 'Success';
          break;
        case 'error':
          iconClass = 'fas fa-exclamation-circle';
          titleText = 'Error';
          break;
        case 'warning':
          iconClass = 'fas fa-exclamation-triangle';
          titleText = 'Warning';
          break;
        default:
          iconClass = 'fas fa-info-circle';
          titleText = 'Information';
      }

      icon.className = 'alert-icon ' + type;
      icon.innerHTML = `<i class="${iconClass}"></i>`;
      title.textContent = titleText;
      messageEl.textContent = message;

      modal.classList.add('show');
    }

    function poCloseAlert() {
      const modal = document.getElementById('poAlertModal');
      const shouldReload = modal.dataset.shouldReload === 'true';
      modal.classList.remove('show');
      
      // Reload page after closing alert if needed
      if (shouldReload) {
        location.reload();
      }
    }

// 1️⃣ Enable global edit mode
function poEnableEditMode() {
  document.getElementById('poEditAllBtn').style.display   = 'none';
  document.getElementById('poSaveAllBtn').style.display   = 'inline-block';
  document.getElementById('poCancelAllBtn').style.display = 'inline-block';

  document.querySelectorAll('#poDetailsTable tbody tr').forEach(row => {
    // ITEM NAME → dropdown
    const nameTd = row.querySelector('.item-name');
    const curr   = nameTd.textContent;
    nameTd.innerHTML = `<select class="edit-item-select">
      ${poItems.map(i=>`<option value="${i.id}" ${i.name===curr?'selected':''}>${i.name}</option>`).join('')}
    </select>`;
    nameTd.querySelector('select').onchange = function(){
      const it = poItems.find(x=>x.id===this.value);
      row.querySelector('.item-id').textContent          = it.id;
      row.querySelector('.item-type').textContent        = it.type;
      row.querySelector('.item-category').textContent    = it.category;
      row.querySelector('.item-subcategory').textContent = it.subcategory;
    };

    // QTY Purchased
    const q = row.querySelector('.qty-purchased').textContent;
    row.querySelector('.qty-purchased').innerHTML =
      `<input type="number" class="edit-qty" value="${q}" min="0">`;

    // Satuan Barang (Unit Type)
    const u = row.querySelector('.unit-type').textContent;
    row.querySelector('.unit-type').innerHTML =
      `<input type="text" class="edit-unit-type" value="${u}" placeholder="kg, lusin, ball, dll">`;

    // Total Harga (manual input)
    const t = row.querySelector('.total-price').textContent;
    row.querySelector('.total-price').innerHTML =
      `<input type="number" class="edit-total-price" value="${parseFloat(t) || 0}" min="0" step="0.01">`;
  });
}

// 3️⃣ Cancel & reload
function poCancelEditMode() {
  const poId = document.querySelector('#poDetailsContent h3').textContent.split(':')[1].trim();
  poViewPODetails(poId);
}

// 4️⃣ Gather all and save
function poSavePODetails() {
  const poId = document.querySelector('#poDetailsContent h3')
                 .textContent.split(':')[1].trim();
  const updates = [];
  document.querySelectorAll('#poDetailsTable tbody tr').forEach(row => {
    updates.push({
      detailId:     row.dataset.detailId,
      poId:         poId,
      itemId:       row.querySelector('.item-id').textContent.trim(),
      itemName:     row.querySelector('.edit-item-select').selectedOptions[0].textContent,
      qtyPurchased: parseFloat(row.querySelector('.edit-qty').value) || 0,
      unitType:     row.querySelector('.edit-unit-type').value.trim(),
      totalPrice:   parseFloat(row.querySelector('.edit-total-price').value) || 0
    });
  });

  poShowProcessing();
  google.script.run
    .withSuccessHandler(()=>{
      poHideProcessing();
      poCloseDetailsModal();
      poLoadPOs();
      poShowAlert('PO Details Updated', 'success');
    })
    .withFailureHandler(err=>{
      console.error('Update failed:', err);
      poHideProcessing();
      poShowAlert('Update failed: ' + (err && err.message ? err.message : err || 'Unknown error'), 'error');
    })
    .poSavePODetails(updates, user.username);
}

// Per‑row delete
function poDeleteDetail(detailId) {
  if (!confirm('Delete this item?')) return;
  poShowProcessing();
  const poId = document.querySelector('#poDetailsContent h3').textContent.split(':')[1].trim();
  google.script.run
    .withSuccessHandler(()=>{
      poHideProcessing();
      poShowAlert('PO Item Deleted', 'success');
      poCloseDetailsModal();
      poLoadPOs();
    })
    .withFailureHandler(err=>{
      console.error('Delete failed:', err);
      poHideProcessing();
      poShowAlert('Delete failed: ' + (err && err.message ? err.message : err || 'Unknown error'), 'error');
    })
    .poDeletePODetail(detailId, poId, user.username);
}

// Edit single detail
function poEditDetail(detailId, btnElement) {
  const row = btnElement.closest('tr');
  const cells = row.cells;
  
  // Get current values (accounting for colspan in date column)
  const itemIdCell = row.querySelector('.item-id');
  const itemNameCell = row.querySelector('.item-name');
  const itemCategoryCell = row.querySelector('.item-category');
  const qtyCell = row.querySelector('.qty-purchased');
  const unitTypeCell = row.querySelector('.unit-type');
  
  const currentItemId = itemIdCell.textContent;
  const currentItemName = itemNameCell.textContent;
  const currentItemCategory = itemCategoryCell.textContent;
  const currentQty = parseFloat(qtyCell.textContent);
  const currentUnitType = unitTypeCell.textContent;
  
  // Build item dropdown
  let itemOptions = '<option value="">-- Select Item --</option>';
  if (poItems && poItems.length > 0) {
    poItems.forEach(item => {
      const selected = item.id === currentItemId ? 'selected' : '';
      itemOptions += `<option value="${item.id}" data-name="${item.name}" data-category="${item.category}" ${selected}>${item.id} - ${item.name}</option>`;
    });
  }
  
  // Replace cells with input fields
  itemIdCell.innerHTML = `<select class="edit-item-select" style="width:100%">${itemOptions}</select>`;
  itemNameCell.innerHTML = `<input type="text" class="edit-item-name" value="${currentItemName}" readonly style="width:100%; background:#f0f0f0">`;
  itemCategoryCell.innerHTML = `<input type="text" class="edit-item-category" value="${currentItemCategory}" readonly style="width:100%; background:#f0f0f0">`;
  qtyCell.innerHTML = `<input type="number" class="edit-qty" value="${currentQty}" min="0.01" step="0.01" style="width:100%">`;
  unitTypeCell.innerHTML = `<input type="text" class="edit-unit-type" value="${currentUnitType}" placeholder="kg, lusin, ball, dll" style="width:100%">`;
  
  // Update item name and category when selection changes
  const selectElement = itemIdCell.querySelector('.edit-item-select');
  selectElement.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    if (selectedOption.value) {
      itemNameCell.querySelector('.edit-item-name').value = selectedOption.getAttribute('data-name');
      itemCategoryCell.querySelector('.edit-item-category').value = selectedOption.getAttribute('data-category');
    }
  });
  
  // Replace action buttons with Save/Cancel
  const actionsCell = row.querySelector('.actions-cell');
  actionsCell.innerHTML = `
    <button class="action-btn save-btn" onclick="poSaveEditDetail('${detailId}', this)" title="Save">
      <i class="fas fa-check"></i>
    </button>
    <button class="action-btn cancel-btn" onclick="poCancelEditDetail('${detailId}')" title="Cancel">
      <i class="fas fa-times"></i>
    </button>
  `;
}

// Save edited detail
function poSaveEditDetail(detailId, btnElement) {
  const row = btnElement.closest('tr');
  
  const itemSelect = row.querySelector('.edit-item-select');
  const itemId = itemSelect.value;
  const itemName = row.querySelector('.edit-item-name').value;
  const itemCategory = row.querySelector('.edit-item-category').value;
  const qty = parseFloat(row.querySelector('.edit-qty').value);
  const unitType = row.querySelector('.edit-unit-type').value.trim();
  
  // Validate
  if (!itemId) {
    poShowAlert('Please select an item', 'error');
    return;
  }
  if (qty <= 0) {
    poShowAlert('Quantity must be greater than 0', 'error');
    return;
  }
  if (!unitType) {
    poShowAlert('Please enter unit type (satuan barang)', 'error');
    return;
  }
  
  poShowProcessing();
  
  const updatedData = {
    itemId: itemId,
    itemName: itemName,
    itemCategory: itemCategory,
    qty: qty,
    unitType: unitType
  };
  
  google.script.run
    .withSuccessHandler(() => {
      poHideProcessing();
      poShowAlert('Detail updated successfully', 'success');
      // Reload the PO details to show updated data
      const poId = document.querySelector('#poDetailsContent h3').textContent.split(':')[1].trim();
      poViewDetails(poId);
    })
    .withFailureHandler(err => {
      poHideProcessing();
      poShowAlert('Update failed: ' + err.message, 'error');
    })
    .poEditPODetail(detailId, updatedData, user.username);
}

// Cancel edit detail
function poCancelEditDetail(detailId) {
  const poId = document.querySelector('#poDetailsContent h3').textContent.split(':')[1].trim();
  poViewDetails(poId);
}

  </script>
