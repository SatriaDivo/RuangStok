<!-- ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; }
    body { background:#f5f7fa; }

    /* Container */
    #dash-container { width:100%;  max-width: 1550px; margin:0 auto; padding:0px; }

    /* Header */
    .dash-header h2 { font-size:2rem; color:#021640; margin-bottom:4px; }
    .dash-header p { font-size:1rem; color:#021640; opacity:0.7; margin-top:2px; }

    /* KPI Cards */
    .dash-kpi-row {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 20px;
      margin: 20px 0;
    }
 .dash-kpi-card {
  background:#fff;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  padding:15px;
  height:100px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  color:#021640; /* Updated color */
}
    .dash-kpi-card h3 {
      font-size: 0.9rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      color: #021640; /* Ensure title color */
    }
    .dash-kpi-card h3 i {
      margin-right: 8px;
    }
    .dash-kpi-card h2 {
      font-size: 1.2rem;
      font-weight: 600;
      color: #021640; /* Ensure result color */
    }

    /* Charts Grid */
    .dash-charts-row { display:flex; gap:20px; width:100%; }
    .dash-col { display:flex; flex-direction:column; gap:20px; }
    .dash-col-1 { width:50%; }
    .dash-col-3 { width:50%; }

    .dash-chart-card {
      background:#fff;
      border-radius:10px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
      padding:15px;
      color:#021640;
    }
    .dash-chart-card h3 { font-size:1rem; margin-bottom:10px; }

    .dash-row { display:flex; gap:20px; }
    .dash-half { width:48%; }
    .dash-full { width:100%; }

    /* Chart Heights */
    #dash-chart1 { height:300px; }
    #dash-chart3, #dash-chart6 { height:300px; }
</style>

<div id="dash-container">
    <div class="dash-header">
      <h2>Dashboard</h2>
      <p>Tren utama dan wawasan bisnis</p>
    </div>

    <div class="dash-kpi-row">
      <!-- KPI cards -->
      <div class="dash-kpi-card"><h3><i class="fas fa-chart-line"></i>Total Penjualan</h3><h2 id="dash-total-sales">Rp 0</h2></div>
      <div class="dash-kpi-card"><h3><i class="fas fa-shopping-cart"></i>Total Pembelian</h3><h2 id="dash-total-purchases">Rp 0</h2></div>
      <div class="dash-kpi-card"><h3><i class="fas fa-dollar-sign"></i>Laba Bersih</h3><h2 id="dash-net-profit">Rp 0</h2></div>
      <div class="dash-kpi-card"><h3><i class="fas fa-boxes"></i>Nilai Inventory</h3><h2 id="dash-total-inventory">Rp 0</h2></div>
      <div class="dash-kpi-card"><h3><i class="fas fa-box-open"></i>Barang Terlaris</h3><h2 id="dash-top-item">â€“</h2></div>
    </div>

    <div class="dash-charts-row">
      <!-- Column 1 -->
      <div class="dash-col dash-col-1">
        <div class="dash-chart-card dash-full">
          <h3>Tren Penjualan</h3>
          <div id="dash-chart1"></div>
        </div>
        <div class="dash-row">
          <div class="dash-chart-card dash-full">
            <h3>Penjualan Berdasarkan Kategori</h3>
            <div id="dash-chart3"></div>
          </div>
        </div>
      </div>



      <!-- Column 3 -->
      <div class="dash-col dash-col-3">
        <div class="dash-row">
          <div class="dash-chart-card dash-full">
            <h3>Pembelian Berdasarkan Kategori</h3>
            <div id="dash-chart6"></div>
          </div>
        </div>
      </div>
    </div>
</div>

<script>
  // Execute immediately in SPA context (no DOMContentLoaded needed)
  const user = SessionManager.getUser();
  const userEmail = user ? user.username : null;

  google.script.run
    .withSuccessHandler(dashRender)
    .withFailureHandler(err => alert('Kesalahan: ' + err.message))
    .dashGetDashboardData(userEmail);

    function dashFmt(v) {
      return 'Rp ' + Math.round(v).toLocaleString('id-ID');
    }

    function dashRender(data) {
      // Check for session expiration
      if (data && data.sessionExpired) {
        SessionManager.clearSession();
        SessionManager.redirectToLogin();
        return;
      }

      // KPIs

      document.getElementById('dash-total-sales').textContent      = dashFmt(data.totalSales);
      document.getElementById('dash-total-purchases').textContent = dashFmt(data.totalPurchases);
      document.getElementById('dash-net-profit').textContent      = dashFmt(data.netProfit);
      document.getElementById('dash-total-inventory').textContent = dashFmt(data.totalInventoryValue);
      document.getElementById('dash-top-item').textContent        = data.topItem;

      // ...Quick Stats removed...

      // Chart 1: Sales Trend (no dataLabels)
// Chart 1: Sales Trend (fixed)
(() => {
  const target = document.querySelector('#dash-chart1');
  const dates  = (data.salesTrend && data.salesTrend.dates)  ? data.salesTrend.dates  : [];
  const values = (data.salesTrend && data.salesTrend.values) ? data.salesTrend.values.map(v => Number(v) || 0) : [];

  // If no data, show a friendly message (prevents a blank card)
  if (!dates.length || !values.length) {
    target.innerHTML = '<div style="padding:8px;color:#666">Data penjualan tidak tersedia</div>';
    return;
  }

  // Label formatter: "yyyy-MM-01" -> "MMM-yy" (and also supports "MM/DD/YYYY" just in case)
  const monthLabel = (val) => {
    // yyyy-MM-01
    if (/^\d{4}-\d{2}-\d{2}$/.test(val)) {
      const [y, m] = val.split('-');
      const d = new Date(Number(y), Number(m) - 1, 1);
      return d.toLocaleString('en-US', { month: 'short' }) + '-' + String(y).slice(-2);
    }
    // MM/DD/YYYY
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(val)) {
      const [mm, dd, yyyy] = val.split('/');
      const d = new Date(Number(yyyy), Number(mm) - 1, 1);
      return d.toLocaleString('en-US', { month: 'short' }) + '-' + String(yyyy).slice(-2);
    }
    // Fallback: show raw value
    return val;
  };

  new ApexCharts(target, {
    chart: {
      type: 'area',
      height: 300,
      fontFamily: 'Arial, sans-serif',
      toolbar: { show: false }
    },
    series: [{
      name: 'Penjualan',
      data: values
    }],
    dataLabels: { enabled: false },
    stroke: {
      curve: 'smooth',
      width: 2,
      colors: ['#021640']
    },
    fill: {
      type: 'gradient',
      gradient: {
        shade: 'light',
        type: 'vertical',
        shadeIntensity: 0.8,
        opacityFrom: 0.7,
        opacityTo: 0.2,
        stops: [0, 100]
      },
      colors: ['#021640']
    },
    markers: {
      size: 2,
      colors: ['#021640'],
      strokeColors: ['#021640'],
      strokeWidth: 2
    },
    // Use category axis (NOT datetime) with your string dates
    xaxis: {
      type: 'category',
      categories: dates,
      labels: {
        formatter: monthLabel,
        style: { colors: '#021640', fontSize: '12px' }
      }
    },
    yaxis: {
      labels: {
        formatter: v => (v / 1000) + 'k',
        style: { colors: '#021640', fontSize: '12px' }
      }
    },
    tooltip: {
      y: { formatter: v => 'Rp ' + Math.round(v).toLocaleString('id-ID') },
      x: { formatter: monthLabel }
    },
    colors: ['#021640'],
    grid: {
      borderColor: '#e0e0e0',
      strokeDashArray: 4
    }
  }).render();
})();

      // Chart 3: Sales By Category
      new ApexCharts(document.querySelector('#dash-chart3'), {
        chart:{ type:'pie', height:300 },
        series: data.salesByCategory.values,
        labels: data.salesByCategory.labels,
        dataLabels:{ enabled:true },
        colors:['#021640','#0066CC','#0099CC','#4572C4','#558ED5','#1F4E79'],
        legend:{ position:'bottom' }
      }).render();

      // Chart 6: Purchase By Category (Stacked, no dataLabels, filtered years 2024 & 2025, increased bar size)
      (function(){
        const pc = data.purchaseByCategory;
        const years = pc.years.filter(y=> y==2024 || y==2025);
        const series = pc.series.map(s=>({ name: s.name, data: years.map(y=> s.data[pc.years.indexOf(y)]||0) }));
        new ApexCharts(document.querySelector('#dash-chart6'), {
          chart:{ type:'bar', height:300, stacked:true, toolbar:{ show:false } },
          series: series,
          dataLabels:{ enabled:false },
          plotOptions:{ bar:{ borderRadius:4, columnWidth:'80%' } },
          xaxis:{ categories: years, labels:{ style:{ colors:'#021640' } } },
          yaxis:{ labels:{ formatter:v=> (v/1000)+'K', style:{ colors:'#021640' } } },
          colors:['#021640','#0099CC','#558ED5','#4572C4','#0066CC','#1F4E79'],
          legend:{ position:'bottom' },
          grid:{ strokeDashArray:4 }
        }).render();
      })();
    }
</script>