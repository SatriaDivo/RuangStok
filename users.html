<!-- Users Management Fragment -->
<style>
  .users-wrapper { max-width: 1200px; margin: 0 auto; }
  .users-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; }
  .users-header h1 { font-size:1.8rem; color:#2c3e50; margin:0; }
  .btn-primary { background:#1abc9c; color:#fff; border:none; padding:10px 18px; border-radius:6px; cursor:pointer; font-size:14px; font-weight:600; }
  .btn-primary:hover { background:#16a085; }
  .users-filters { display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap; }
  .users-filters input { padding:8px 10px; border:1px solid #ccc; border-radius:5px; }
  table.users-table { width:100%; border-collapse:collapse; background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.08); border-radius:8px; overflow:hidden; }
  table.users-table thead { background:#008080; color:#fff; }
  table.users-table th, table.users-table td { padding:10px 12px; font-size:13px; border-bottom:1px solid #eee; text-align:left; }
  table.users-table tbody tr:hover { background:#f5fdfc; }
  .badge { display:inline-block; padding:4px 10px; border-radius:12px; font-size:11px; font-weight:600; }
  .badge-admin { background:#e74c3c; color:#fff; }
  .badge-staff { background:#3498db; color:#fff; }
  .badge-active { background:#27ae60; color:#fff; }
  .badge-inactive { background:#bdc3c7; color:#2c3e50; }
  .actions button { background:transparent; border:none; cursor:pointer; padding:4px 6px; }
  .actions button.edit { color:#3498db; }
  .actions button.reset { color:#f39c12; }
  .actions button.delete { color:#e74c3c; }
  .empty-state { text-align:center; padding:40px 20px; color:#7f8c8d; }
  .modal-backdrop { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; z-index:10000; }
  .modal { background:#fff; border-radius:10px; padding:25px 30px; width:400px; max-width:90%; box-shadow:0 10px 25px rgba(0,0,0,.15); }
  .modal h3 { margin-top:0; color:#2c3e50; }
  .modal form { display:flex; flex-direction:column; gap:12px; }
  .modal input, .modal select { padding:8px 10px; border:1px solid #ccc; border-radius:6px; }
  .modal-footer { display:flex; justify-content:flex-end; gap:10px; margin-top:10px; }
  .btn-secondary { background:#bdc3c7; color:#2c3e50; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
  .btn-secondary:hover { background:#aeb4b6; }
  .btn-danger { background:#e74c3c; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
  .btn-danger:hover { background:#c0392b; }
  .btn-warning { background:#f39c12; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
  .btn-warning:hover { background:#d68910; }
  .small { font-size:11px; color:#95a5a6; }
  .confirm-icon { font-size: 48px; margin-bottom: 15px; }
  .confirm-icon.warning { color: #f39c12; }
  .confirm-icon.danger { color: #e74c3c; }
  .confirm-text { text-align: center; margin-bottom: 20px; }
  .confirm-text h3 { margin: 0 0 10px 0; color: #2c3e50; }
  .confirm-text p { margin: 0; color: #7f8c8d; font-size: 14px; }
  .confirm-text .highlight { background: #f8f9fa; padding: 8px 12px; border-radius: 6px; margin-top: 10px; font-family: monospace; color: #27ae60; font-weight: bold; }
  
  /* Form Modal Styling */
  .modal-header { text-align: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #ecf0f1; }
  .modal-header .header-icon { font-size: 42px; margin-bottom: 10px; }
  .modal-header .header-icon.edit { color: #3498db; }
  .modal-header .header-icon.add { color: #27ae60; }
  .modal-header h3 { margin: 0; color: #2c3e50; font-size: 20px; }
  .modal-header p { margin: 5px 0 0; color: #7f8c8d; font-size: 13px; }
  .form-group { margin-bottom: 15px; }
  .form-group label { display: block; margin-bottom: 6px; color: #2c3e50; font-weight: 500; font-size: 13px; }
  .form-group label i { margin-right: 6px; color: #3498db; width: 16px; }
  .input-wrapper { position: relative; }
  .input-wrapper i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #95a5a6; font-size: 14px; }
  .input-wrapper input, .input-wrapper select { width: 100%; padding: 10px 12px 10px 38px; border: 1px solid #dce0e5; border-radius: 8px; font-size: 14px; transition: all 0.2s ease; box-sizing: border-box; }
  .input-wrapper input:focus, .input-wrapper select:focus { border-color: #3498db; box-shadow: 0 0 0 3px rgba(52,152,219,0.15); outline: none; }
  .input-wrapper input::placeholder { color: #bdc3c7; }
  .form-hint { font-size: 11px; color: #95a5a6; margin-top: 4px; }
  .modal-footer-form { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px solid #ecf0f1; }
  
  /* Toast Notification */
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 25px;
    border-radius: 8px;
    color: #fff;
    font-weight: 500;
    z-index: 99999;
    animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }
  .toast.success { background: #27ae60; }
  .toast.error { background: #e74c3c; }
  .toast.info { background: #3498db; }
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
  }
  
  /* Responsive Design */
  @media screen and (max-width: 1024px) {
    .users-wrapper {
      padding: 15px;
    }
  }
  
  @media screen and (max-width: 768px) {
    .users-wrapper {
      padding: 10px;
    }
    
    .users-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 15px;
    }
    
    .users-header h1 {
      font-size: 1.5rem;
    }
    
    .btn-primary {
      width: 100%;
      justify-content: center;
    }
    
    .users-filters {
      flex-direction: column;
      width: 100%;
    }
    
    .users-filters input {
      width: 100%;
    }
    
    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    table.users-table {
      min-width: 800px;
      font-size: 12px;
    }
    
    table.users-table th,
    table.users-table td {
      padding: 8px;
    }
    
    .modal {
      width: 95%;
      padding: 20px;
    }
    
    .modal input,
    .modal select {
      width: 100%;
    }
  }
  
  @media screen and (max-width: 480px) {
    .users-header h1 {
      font-size: 1.2rem;
    }
    
    table.users-table {
      font-size: 11px;
    }
    
    table.users-table th,
    table.users-table td {
      padding: 6px;
    }
    
    .badge {
      font-size: 10px;
      padding: 3px 8px;
    }
    
    .btn-primary,
    .btn-secondary {
      padding: 8px 12px;
      font-size: 13px;
    }
  }
</style>

<div class="users-wrapper">
  <div class="users-header">
    <h1><i class="fas fa-user-cog" style="margin-right:8px;color:#1abc9c"></i>Manajemen Pengguna</h1>
    <button class="btn-primary" onclick="openUserModal()"><i class="fas fa-plus" style="margin-right:6px"></i>Tambah Pengguna</button>
  </div>

  <div class="users-filters">
    <input type="text" id="searchUser" placeholder="Cari nama / email" oninput="renderUsers()" />
    <input type="text" id="filterRole" placeholder="Filter peran (admin/staff)" oninput="renderUsers()" />
    <input type="text" id="filterStatus" placeholder="Filter status (active/inactive)" oninput="renderUsers()" />
  </div>

  <div class="table-wrapper">
    <table class="users-table" id="usersTable">
      <thead>
        <tr>
          <th>Nama</th>
          <th>Email</th>
          <th>Peran</th>
          <th>Status</th>
          <th>Dibuat</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="usersTbody">
        <tr><td colspan="6" class="empty-state">Memuat data pengguna...</td></tr>
      </tbody>
    </table>
    <div class="small" style="margin-top:8px;">Data pengguna dari Google Sheets</div>
  </div>
</div>

<script>
  // Get user from session
  const userStr = localStorage.getItem('ruangstok_user') || sessionStorage.getItem('ruangstok_user');
  const user = userStr ? JSON.parse(userStr) : null;

  // Data users dari Google Sheets
  let users = [];
  let editingId = null;

  // Toast notification function
  function showToast(message, type = 'success') {
    const existing = document.querySelector('.toast');
    if (existing) existing.remove();
    
    const toast = document.createElement('div');
    toast.className = 'toast ' + type;
    toast.innerHTML = '<i class="fas fa-' + (type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle') + '"></i> ' + message;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.remove(), 3000);
  }

  // Load data dari backend
  function loadUsers() {
    console.log('üîÑ loadUsers called, user:', user);
    
    if (!user) {
      console.error('‚ùå No user session found');
      document.getElementById('usersTbody').innerHTML = 
        '<tr><td colspan="6" class="empty-state" style="color:#e74c3c;">Sesi tidak valid. Silakan login kembali.</td></tr>';
      return;
    }

    console.log('üì° Calling usersGetAll with username:', user.username);
    
    google.script.run
      .withSuccessHandler(function(data) {
        console.log('‚úÖ usersGetAll success, data:', data);
        users = data || [];
        renderUsers();
      })
      .withFailureHandler(function(error) {
        console.error('‚ùå usersGetAll error:', error);
        document.getElementById('usersTbody').innerHTML = 
          '<tr><td colspan="6" class="empty-state" style="color:#e74c3c;">Error: ' + error.message + '</td></tr>';
      })
      .usersGetAll(user.username);
  }

  function badge(text, type) {
    const map = { admin:'badge badge-admin', staff:'badge badge-staff', active:'badge badge-active', inactive:'badge badge-inactive' };
    return `<span class="${map[type]||'badge'}">${text}</span>`;
  }

  function renderUsers() {
    const search = document.getElementById('searchUser').value.toLowerCase();
    const roleF = document.getElementById('filterRole').value.toLowerCase();
    const statusF = document.getElementById('filterStatus').value.toLowerCase();
    const tbody = document.getElementById('usersTbody');

    const filtered = users.filter(u => {
      const userName = (u.name || '').toLowerCase();
      const userEmail = (u.email || '').toLowerCase();
      const userRole = (u.role || '').toLowerCase();
      const userStatus = (u.status || '').toLowerCase();
      
      return (!search || userName.includes(search) || userEmail.includes(search)) &&
             (!roleF || userRole.includes(roleF)) &&
             (!statusF || userStatus.includes(statusF));
    });

    if (!filtered.length) {
      tbody.innerHTML = `<tr><td colspan="6" class="empty-state">Tidak ada data</td></tr>`;
      return;
    }

    tbody.innerHTML = filtered.map(u => `
      <tr>
        <td>${u.name}</td>
        <td>${u.email}</td>
        <td>${badge(u.role, u.role)}</td>
        <td>${badge(u.status, u.status)}</td>
        <td>${u.created}</td>
        <td class="actions">
          <button class="edit" title="Edit" onclick="editUser('${u.id}')"><i class="fas fa-edit"></i></button>
          <button class="reset" title="Reset Password" onclick="resetPassword('${u.id}', '${u.name}')"><i class="fas fa-key"></i></button>
          <button class="delete" title="Hapus" onclick="deleteUser('${u.id}', '${u.name}')"><i class="fas fa-trash"></i></button>
        </td>
      </tr>`).join('');
  }

  function openUserModal(edit=false) {
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop';
    
    let user = { name:'', email:'', role:'Staff', status:'Active' };
    if (edit && editingId) {
      console.log('Looking for user with id:', editingId);
      const foundUser = users.find(u => String(u.id) === String(editingId));
      console.log('Found user:', foundUser);
      if (foundUser) {
        user = foundUser;
      }
    }
    
    backdrop.innerHTML = `
      <div class="modal">
        <div class="modal-header">
          <div class="header-icon ${edit ? 'edit' : 'add'}">
            <i class="fas ${edit ? 'fa-user-edit' : 'fa-user-plus'}"></i>
          </div>
          <h3>${edit ? 'Edit Pengguna' : 'Tambah Pengguna Baru'}</h3>
          <p>${edit ? 'Perbarui informasi pengguna' : 'Isi data untuk menambah pengguna baru'}</p>
        </div>
        <form onsubmit="saveUser(event)">
          <div class="form-group">
            <label><i class="fas fa-user"></i>Nama Lengkap</label>
            <div class="input-wrapper">
              <i class="fas fa-user"></i>
              <input type="text" id="uName" placeholder="Masukkan nama lengkap" required value="${user.name||''}" />
            </div>
          </div>
          <div class="form-group">
            <label><i class="fas fa-envelope"></i>Email</label>
            <div class="input-wrapper">
              <i class="fas fa-envelope"></i>
              <input type="email" id="uEmail" placeholder="contoh@email.com" required value="${user.email||''}" />
            </div>
          </div>
          <div class="form-group">
            <label><i class="fas fa-lock"></i>Password</label>
            <div class="input-wrapper">
              <i class="fas fa-lock"></i>
              <input type="password" id="uPassword" placeholder="${edit?'Kosongkan jika tidak mengubah':'Masukkan password'}" ${edit?'':'required'} />
            </div>
            ${edit ? '<div class="form-hint">Biarkan kosong jika tidak ingin mengubah password</div>' : ''}
          </div>
          <div class="form-group">
            <label><i class="fas fa-user-tag"></i>Role</label>
            <div class="input-wrapper">
              <i class="fas fa-user-tag"></i>
              <select id="uRole">
                <option value="Admin" ${user.role==='Admin'?'selected':''}>Admin</option>
                <option value="Staff" ${user.role==='Staff'?'selected':''}>Staff</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label><i class="fas fa-toggle-on"></i>Status</label>
            <div class="input-wrapper">
              <i class="fas fa-toggle-on"></i>
              <select id="uStatus">
                <option value="Active" ${user.status==='Active'?'selected':''}>Active</option>
                <option value="Inactive" ${user.status==='Inactive'?'selected':''}>Inactive</option>
              </select>
            </div>
          </div>
          <div class="modal-footer-form">
            <button type="button" class="btn-secondary" onclick="this.closest('.modal-backdrop').remove()"><i class="fas fa-times"></i> Batal</button>
            <button type="submit" class="btn-primary"><i class="fas fa-save"></i> Simpan</button>
          </div>
        </form>
      </div>`;
    document.body.appendChild(backdrop);
  }

  function editUser(id) { 
    console.log('editUser called with id:', id, 'type:', typeof id);
    editingId = String(id); 
    console.log('editingId set to:', editingId);
    console.log('Available users:', users.map(u => ({ id: u.id, name: u.name })));
    openUserModal(true); 
  }

  function saveUser(e) {
    e.preventDefault();
    const name = document.getElementById('uName').value.trim();
    const email = document.getElementById('uEmail').value.trim();
    const password = document.getElementById('uPassword').value.trim();
    const role = document.getElementById('uRole').value;
    const status = document.getElementById('uStatus').value;

    const userData = { name, email, password, role, status };
    
    if (editingId) {
      // Update user
      userData.id = editingId;
      google.script.run
        .withSuccessHandler(function(success) {
          if (success) {
            document.querySelector('.modal-backdrop').remove();
            editingId = null;
            showToast('Data pengguna berhasil diubah!', 'success');
            loadUsers(); // Reload data
          }
        })
        .withFailureHandler(function(error) {
          showToast('Error: ' + error.message, 'error');
        })
        .usersUpdate(userData, user.username);
    } else {
      // Add new user
      google.script.run
        .withSuccessHandler(function(success) {
          if (success) {
            document.querySelector('.modal-backdrop').remove();
            showToast('Pengguna baru berhasil ditambahkan!', 'success');
            loadUsers(); // Reload data
          }
        })
        .withFailureHandler(function(error) {
          showToast('Error: ' + error.message, 'error');
        })
        .usersAdd(userData, user.username);
    }
  }

  function deleteUser(id, name) {
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop';
    backdrop.innerHTML = `
      <div class="modal" style="text-align:center;">
        <div class="confirm-icon danger"><i class="fas fa-trash-alt"></i></div>
        <div class="confirm-text">
          <h3>Hapus Pengguna</h3>
          <p>Anda yakin ingin menghapus <strong>"${name}"</strong>?</p>
          <p style="color:#e74c3c; font-size:12px; margin-top:8px;">Tindakan ini tidak dapat dibatalkan!</p>
        </div>
        <div class="modal-footer" style="justify-content:center;">
          <button class="btn-secondary" onclick="this.closest('.modal-backdrop').remove()">Batal</button>
          <button class="btn-danger" onclick="confirmDeleteUser('${id}')">Ya, Hapus</button>
        </div>
      </div>`;
    document.body.appendChild(backdrop);
  }

  function confirmDeleteUser(id) {
    document.querySelector('.modal-backdrop').remove();
    
    google.script.run
      .withSuccessHandler(function(success) {
        if (success) {
          showToast('Pengguna berhasil dihapus!', 'success');
          loadUsers(); // Reload data
        }
      })
      .withFailureHandler(function(error) {
        showToast('Error: ' + error.message, 'error');
      })
      .usersDelete(id, user.username);
  }

  function resetPassword(id, name) {
    const defaultPassword = 'ruangstok123';
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop';
    backdrop.innerHTML = `
      <div class="modal" style="text-align:center;">
        <div class="confirm-icon warning"><i class="fas fa-key"></i></div>
        <div class="confirm-text">
          <h3>Reset Password</h3>
          <p>Reset password untuk <strong>"${name}"</strong>?</p>
          <div class="highlight">Password baru: ${defaultPassword}</div>
        </div>
        <div class="modal-footer" style="justify-content:center;">
          <button class="btn-secondary" onclick="this.closest('.modal-backdrop').remove()">Batal</button>
          <button class="btn-warning" onclick="confirmResetPassword('${id}', '${defaultPassword}')">Reset Password</button>
        </div>
      </div>`;
    document.body.appendChild(backdrop);
  }

  function confirmResetPassword(id, defaultPassword) {
    document.querySelector('.modal-backdrop').remove();
    
    google.script.run
      .withSuccessHandler(function(success) {
        if (success) {
          showToast('Password berhasil direset ke: ' + defaultPassword, 'success');
        }
      })
      .withFailureHandler(function(error) {
        showToast('Error: ' + error.message, 'error');
      })
      .usersResetPassword(id);
  }

  // Initial load - panggil loadUsers untuk ambil data dari Sheets
  loadUsers();
</script>
<!-- End Users Management Fragment -->
