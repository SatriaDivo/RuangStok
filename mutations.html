<!-- Mutations / Mutasi Stok Page -->
<style>
  .mutations-container {
    padding: 20px;
  }
  
  .mutations-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
  }
  
  .mutations-title {
    font-size: 1.8rem;
    font-weight: 600;
    color: #2c3e50;
    margin: 0;
  }
  
  .mutations-title i {
    color: #1abc9c;
    margin-right: 10px;
  }
  
  /* Summary Cards */
  .mutations-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
  }
  
  .summary-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 15px;
  }
  
  .summary-card.in {
    border-left: 4px solid #27ae60;
  }
  
  .summary-card.out {
    border-left: 4px solid #e74c3c;
  }
  
  .summary-card.net {
    border-left: 4px solid #3498db;
  }
  
  .summary-card.total {
    border-left: 4px solid #9b59b6;
  }
  
  .summary-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
  }
  
  .summary-card.in .summary-icon {
    background: rgba(39, 174, 96, 0.15);
    color: #27ae60;
  }
  
  .summary-card.out .summary-icon {
    background: rgba(231, 76, 60, 0.15);
    color: #e74c3c;
  }
  
  .summary-card.net .summary-icon {
    background: rgba(52, 152, 219, 0.15);
    color: #3498db;
  }
  
  .summary-card.total .summary-icon {
    background: rgba(155, 89, 182, 0.15);
    color: #9b59b6;
  }
  
  .summary-info h4 {
    margin: 0;
    font-size: 0.85rem;
    color: #7f8c8d;
    font-weight: 500;
  }
  
  .summary-info .value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #2c3e50;
  }
  
  /* Filters */
  .mutations-filters {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  }
  
  .filters-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: flex-end;
  }
  
  .filter-group {
    flex: 1;
    min-width: 150px;
  }
  
  .filter-group label {
    display: block;
    font-size: 0.85rem;
    color: #7f8c8d;
    margin-bottom: 5px;
    font-weight: 500;
  }
  
  .filter-group input,
  .filter-group select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    font-size: 0.95rem;
    transition: border-color 0.2s;
  }
  
  .filter-group input:focus,
  .filter-group select:focus {
    outline: none;
    border-color: #1abc9c;
  }
  
  .filter-buttons {
    display: flex;
    gap: 10px;
  }
  
  .btn-filter {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 0.95rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
  }
  
  .btn-filter.primary {
    background: #1abc9c;
    color: white;
  }
  
  .btn-filter.primary:hover {
    background: #16a085;
  }
  
  .btn-filter.secondary {
    background: #ecf0f1;
    color: #7f8c8d;
  }
  
  .btn-filter.secondary:hover {
    background: #bdc3c7;
  }
  
  /* Table */
  .mutations-table-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    overflow: hidden;
  }
  
  .mutations-table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .mutations-table th {
    background: #2c3e50;
    color: white;
    padding: 15px;
    text-align: left;
    font-weight: 500;
    font-size: 0.9rem;
  }
  
  .mutations-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #f0f0f0;
    font-size: 0.9rem;
    color: #34495e;
  }
  
  .mutations-table tbody tr:hover {
    background: #f8f9fa;
  }
  
  .mutations-table tbody tr:last-child td {
    border-bottom: none;
  }
  
  /* Type badges */
  .badge-in {
    background: rgba(39, 174, 96, 0.15);
    color: #27ae60;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }
  
  .badge-out {
    background: rgba(231, 76, 60, 0.15);
    color: #e74c3c;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }
  
  .reference-link {
    color: #3498db;
    text-decoration: none;
    font-weight: 500;
  }
  
  .reference-link:hover {
    text-decoration: underline;
  }
  
  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #7f8c8d;
  }
  
  .empty-state i {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.5;
  }
  
  .empty-state h3 {
    margin: 0 0 10px;
    color: #2c3e50;
  }
  
  /* Loading */
  .loading-state {
    text-align: center;
    padding: 60px 20px;
    color: #7f8c8d;
  }
  
  .loading-state i {
    font-size: 3rem;
    margin-bottom: 15px;
    color: #1abc9c;
  }
  
  /* Responsive */
  @media (max-width: 1200px) {
    .mutations-summary {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  @media (max-width: 992px) {
    .filters-row {
      flex-wrap: wrap;
    }
    
    .filter-group {
      min-width: calc(50% - 10px);
      flex: 0 0 calc(50% - 10px);
    }
    
    .filter-buttons {
      width: 100%;
      justify-content: flex-start;
      margin-top: 10px;
    }
  }
  
  @media (max-width: 768px) {
    .mutations-container {
      padding: 15px;
    }
    
    .mutations-header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .mutations-title {
      font-size: 1.4rem;
    }
    
    .mutations-summary {
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    .summary-card {
      padding: 15px;
    }
    
    .summary-icon {
      width: 40px;
      height: 40px;
      font-size: 1.2rem;
    }
    
    .summary-info .value {
      font-size: 1.2rem;
    }
    
    .summary-info h4 {
      font-size: 0.75rem;
    }
    
    .filters-row {
      flex-direction: column;
    }
    
    .filter-group {
      width: 100%;
      flex: 0 0 100%;
      min-width: 100%;
    }
    
    .filter-buttons {
      flex-wrap: wrap;
    }
    
    .btn-filter {
      flex: 1;
      justify-content: center;
      min-width: 100px;
    }
    
    .mutations-table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .mutations-table {
      min-width: 650px;
    }
    
    .mutations-table th,
    .mutations-table td {
      padding: 10px 8px;
      font-size: 0.8rem;
    }
  }
  
  @media (max-width: 576px) {
    .mutations-container {
      padding: 10px;
    }
    
    .mutations-title {
      font-size: 1.2rem;
    }
    
    .mutations-title i {
      margin-right: 8px;
    }
    
    .mutations-summary {
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .summary-card {
      padding: 12px;
      gap: 10px;
    }
    
    .summary-icon {
      width: 35px;
      height: 35px;
      font-size: 1rem;
    }
    
    .summary-info .value {
      font-size: 1rem;
    }
    
    .summary-info h4 {
      font-size: 0.7rem;
    }
    
    .mutations-filters {
      padding: 15px;
    }
    
    .filter-group label {
      font-size: 0.8rem;
    }
    
    .filter-group input,
    .filter-group select {
      padding: 8px 10px;
      font-size: 0.85rem;
    }
    
    .btn-filter {
      padding: 8px 12px;
      font-size: 0.85rem;
    }
    
    .mutations-table {
      min-width: 550px;
    }
    
    .mutations-table th {
      padding: 10px 6px;
      font-size: 0.75rem;
    }
    
    .mutations-table td {
      padding: 8px 6px;
      font-size: 0.75rem;
    }
    
    .badge-in, .badge-out {
      padding: 4px 8px;
      font-size: 0.7rem;
    }
    
    .empty-state {
      padding: 40px 15px;
    }
    
    .empty-state i {
      font-size: 3rem;
    }
    
    .empty-state h3 {
      font-size: 1rem;
    }
    
    .empty-state p {
      font-size: 0.85rem;
    }
  }
  
  @media (max-width: 400px) {
    .mutations-summary {
      grid-template-columns: 1fr;
    }
    
    .summary-card {
      flex-direction: row;
      justify-content: flex-start;
    }
    
    .filter-buttons {
      flex-direction: column;
    }
    
    .btn-filter {
      width: 100%;
    }
    
    .mutations-table {
      min-width: 480px;
    }
    
    .mutations-table th,
    .mutations-table td {
      padding: 6px 4px;
      font-size: 0.7rem;
    }
  }
</style>

<div class="mutations-container">
  <!-- Header -->
  <div class="mutations-header">
    <h1 class="mutations-title">
      <i class="fas fa-exchange-alt"></i>Mutasi Stok
    </h1>
  </div>
  
  <!-- Summary Cards -->
  <div class="mutations-summary">
    <div class="summary-card in">
      <div class="summary-icon">
        <i class="fas fa-arrow-down"></i>
      </div>
      <div class="summary-info">
        <h4>Total Masuk</h4>
        <div class="value" id="totalIn">0</div>
      </div>
    </div>
    
    <div class="summary-card out">
      <div class="summary-icon">
        <i class="fas fa-arrow-up"></i>
      </div>
      <div class="summary-info">
        <h4>Total Keluar</h4>
        <div class="value" id="totalOut">0</div>
      </div>
    </div>
    
    <div class="summary-card net">
      <div class="summary-icon">
        <i class="fas fa-balance-scale"></i>
      </div>
      <div class="summary-info">
        <h4>Selisih Bersih</h4>
        <div class="value" id="netChange">0</div>
      </div>
    </div>
    
    <div class="summary-card total">
      <div class="summary-icon">
        <i class="fas fa-list"></i>
      </div>
      <div class="summary-info">
        <h4>Total Transaksi</h4>
        <div class="value" id="totalTransactions">0</div>
      </div>
    </div>
  </div>
  
  <!-- Filters -->
  <div class="mutations-filters">
    <div class="filters-row">
      <div class="filter-group">
        <label>Tanggal Mulai</label>
        <input type="date" id="filterStartDate">
      </div>
      
      <div class="filter-group">
        <label>Tanggal Akhir</label>
        <input type="date" id="filterEndDate">
      </div>
      
      <div class="filter-group">
        <label>Cari Item</label>
        <input type="text" id="filterItem" placeholder="ID atau nama item...">
      </div>
      
      <div class="filter-group">
        <label>Jenis Mutasi</label>
        <select id="filterType">
          <option value="ALL">Semua</option>
          <option value="IN">Masuk</option>
          <option value="OUT">Keluar</option>
        </select>
      </div>
      
      <div class="filter-buttons">
        <button class="btn-filter primary" onclick="loadMutations()">
          <i class="fas fa-search"></i> Filter
        </button>
        <button class="btn-filter secondary" onclick="resetFilters()">
          <i class="fas fa-undo"></i> Reset
        </button>
      </div>
    </div>
  </div>
  
  <!-- Table -->
  <div class="mutations-table-container">
    <table class="mutations-table">
      <thead>
        <tr>
          <th>Tanggal</th>
          <th>Item ID</th>
          <th>Nama Barang</th>
          <th>Jenis</th>
          <th>Qty</th>
          <th>Referensi</th>
          <th>Catatan</th>
        </tr>
      </thead>
      <tbody id="mutationsTableBody">
        <tr>
          <td colspan="7" class="loading-state">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Memuat data mutasi...</p>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  let mutUserEmail = null;
  let initAttempts = 0;
  const maxInitAttempts = 5;
  
  // Function to initialize mutations page
  function initMutationsPage() {
    initAttempts++;
    console.log('Initializing Mutations page - Attempt:', initAttempts);
    
    // Get user from localStorage or sessionStorage (same pattern as inventory.html)
    try {
      const userStr = localStorage.getItem('ruangstok_user') || sessionStorage.getItem('ruangstok_user');
      console.log('User string from storage:', userStr);
      
      if (userStr) {
        const user = JSON.parse(userStr);
        mutUserEmail = user ? user.username : null;
        console.log('User email:', mutUserEmail);
      } else {
        console.warn('No user found in storage');
        mutUserEmail = null;
      }
    } catch (e) {
      console.error('Error getting user:', e);
      mutUserEmail = null;
    }
    
    // Set default date range (today's date)
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    
    const startDateEl = document.getElementById('filterStartDate');
    const endDateEl = document.getElementById('filterEndDate');
    const tbody = document.getElementById('mutationsTableBody');
    
    // Check if elements exist
    if (!startDateEl || !endDateEl || !tbody) {
      console.warn('Elements not ready yet. Found:', { 
        startDateEl: !!startDateEl, 
        endDateEl: !!endDateEl, 
        tbody: !!tbody 
      });
      
      // Retry if not exceeded max attempts
      if (initAttempts < maxInitAttempts) {
        setTimeout(initMutationsPage, 200);
      } else {
        console.error('Failed to initialize after', maxInitAttempts, 'attempts');
        if (tbody) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Gagal menginisialisasi halaman</h3>
                <p>Silakan refresh halaman</p>
                <button onclick="location.reload()" style="margin-top:10px; padding:8px 16px; background:#1abc9c; color:white; border:none; border-radius:6px; cursor:pointer;">
                  <i class="fas fa-redo"></i> Refresh
                </button>
              </td>
            </tr>
          `;
        }
      }
      return;
    }
    
    // Elements found, clear default values (show all data by default)
    endDateEl.value = '';
    startDateEl.value = '';
    console.log('Filter inputs cleared for showing all data');
    
    // Check if user email is available before loading
    if (!mutUserEmail) {
      console.warn('User email not available, showing message');
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Sesi tidak valid</h3>
            <p>Silakan login kembali atau refresh halaman</p>
            <button onclick="location.reload()" style="margin-top:10px; padding:8px 16px; background:#1abc9c; color:white; border:none; border-radius:6px; cursor:pointer;">
              <i class="fas fa-redo"></i> Refresh
            </button>
          </td>
        </tr>
      `;
      return;
    }
    
    // Load ALL data by default (no filter)
    console.log('Loading all mutations with email:', mutUserEmail);
    loadAllMutations();
  }
  
  // Initialize when script loads
  // Wait for DOM and SessionManager to be ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(initMutationsPage, 300);
    });
  } else {
    setTimeout(initMutationsPage, 300);
  }
  
  /**
   * Load ALL mutations (no filter) - same pattern as inventory, suppliers
   */
  function loadAllMutations() {
    const tbody = document.getElementById('mutationsTableBody');
    
    if (!mutUserEmail) {
      console.warn('No user email');
      return;
    }
    
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="loading-state">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Memuat data mutasi...</p>
        </td>
      </tr>
    `;
    
    console.log('Calling mutLoadAllData with email:', mutUserEmail);
    
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('mutLoadAllData result:', result);
        handleMutationsResult(result);
      })
      .withFailureHandler(function(error) {
        console.error('Error:', error);
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <i class="fas fa-exclamation-triangle"></i>
              <h3>Gagal memuat data</h3>
              <p>${error.message || error}</p>
              <button onclick="loadAllMutations()" style="margin-top:10px; padding:8px 16px; background:#1abc9c; color:white; border:none; border-radius:6px; cursor:pointer;">
                <i class="fas fa-redo"></i> Coba Lagi
              </button>
            </td>
          </tr>
        `;
      })
      .mutLoadAllData(mutUserEmail);
  }  
  /**
   * Load filtered mutations - called by Filter button
   */
  function loadMutations() {
    const tbody = document.getElementById('mutationsTableBody');
    
    // Check if user email is available
    if (!mutUserEmail) {
      console.warn('User email not available, trying to get from storage');
      try {
        const userStr = localStorage.getItem('ruangstok_user') || sessionStorage.getItem('ruangstok_user');
        if (userStr) {
          const user = JSON.parse(userStr);
          mutUserEmail = user ? user.username : null;
        }
      } catch (e) {
        console.error('Failed to get user from storage:', e);
      }
      
      if (!mutUserEmail) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <i class="fas fa-exclamation-triangle"></i>
              <h3>Sesi tidak valid</h3>
              <p>Silakan login kembali</p>
            </td>
          </tr>
        `;
        return;
      }
    }
    
    // Build filter object
    const filter = {};
    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;
    const itemId = document.getElementById('filterItem').value;
    const type = document.getElementById('filterType').value;
    
    if (startDate) filter.startDate = startDate;
    if (endDate) filter.endDate = endDate;
    if (itemId) filter.itemId = itemId;
    if (type && type !== 'ALL') filter.type = type;
    
    // If no filters, load all
    if (Object.keys(filter).length === 0) {
      loadAllMutations();
      return;
    }
    
    console.log('Loading filtered mutations:', filter);
    
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="loading-state">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Memuat data mutasi...</p>
        </td>
      </tr>
    `;
    
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('mutLoadFilteredData result:', result);
        handleMutationsResult(result);
      })
      .withFailureHandler(function(error) {
        console.error('Error:', error);
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="empty-state">
              <i class="fas fa-exclamation-triangle"></i>
              <h3>Gagal memuat data</h3>
              <p>${error.message || error}</p>
              <button onclick="loadMutations()" style="margin-top:10px; padding:8px 16px; background:#1abc9c; color:white; border:none; border-radius:6px; cursor:pointer;">
                <i class="fas fa-redo"></i> Coba Lagi
              </button>
            </td>
          </tr>
        `;
      })
      .mutLoadFilteredData(mutUserEmail, filter);
  }
  
  function handleMutationsResult(result) {
    console.log('=== handleMutationsResult START ===');
    console.log('Raw result:', result);
    console.log('Result type:', typeof result);
    console.log('Is array:', Array.isArray(result));
    
    const tbody = document.getElementById('mutationsTableBody');
    
    // Check for session expired (object response)
    if (result && result.sessionExpired) {
      SessionManager.handleSessionExpired();
      return;
    }
    
    // Handle ARRAY response (like inventory)
    let mutations = [];
    
    if (Array.isArray(result)) {
      // Direct array response
      mutations = result;
      console.log('Received array with', mutations.length, 'items');
    } else if (result && result.data) {
      // Object with data property
      mutations = result.data;
    } else if (!result) {
      console.error('No result received from server');
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Gagal memuat data</h3>
            <p>Tidak ada respon dari server.</p>
            <button onclick="loadAllMutations()" style="margin-top:10px; padding:8px 16px; background:#1abc9c; color:white; border:none; border-radius:6px; cursor:pointer;">
              <i class="fas fa-redo"></i> Coba Lagi
            </button>
          </td>
        </tr>
      `;
      return;
    }
    
    // Calculate summary from data
    let totalIn = 0, totalOut = 0;
    mutations.forEach(m => {
      if (m.type === 'IN') totalIn += m.qty;
      else if (m.type === 'OUT') totalOut += m.qty;
    });
    
    // Update summary cards
    document.getElementById('totalIn').textContent = totalIn.toLocaleString('id-ID');
    document.getElementById('totalOut').textContent = totalOut.toLocaleString('id-ID');
    document.getElementById('netChange').textContent = (totalIn - totalOut).toLocaleString('id-ID');
    document.getElementById('totalTransactions').textContent = mutations.length.toLocaleString('id-ID');
    
    // Render table
    if (mutations.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="empty-state">
            <i class="fas fa-inbox"></i>
            <h3>Tidak ada data mutasi</h3>
            <p>Belum ada pergerakan stok</p>
          </td>
        </tr>
      `;
      return;
    }
    
    let html = '';
    mutations.forEach(m => {
      const date = m.date ? new Date(m.date).toLocaleDateString('id-ID', { 
        day: '2-digit', month: 'short', year: 'numeric' 
      }) : '-';
      
      const typeBadge = m.type === 'IN' 
        ? '<span class="badge-in"><i class="fas fa-arrow-down"></i> Masuk</span>'
        : '<span class="badge-out"><i class="fas fa-arrow-up"></i> Keluar</span>';
      
      html += `
        <tr>
          <td>${date}</td>
          <td><strong>${m.itemId || '-'}</strong></td>
          <td>${m.itemName || '-'}</td>
          <td>${typeBadge}</td>
          <td style="text-align: center; font-weight: 600;">${m.qty}</td>
          <td>${m.reference || '-'}</td>
          <td>${m.notes || '-'}</td>
        </tr>
      `;
    });
    
    tbody.innerHTML = html;
  }
  
  function resetFilters() {
    // Clear all filter inputs
    document.getElementById('filterEndDate').value = '';
    document.getElementById('filterStartDate').value = '';
    document.getElementById('filterItem').value = '';
    document.getElementById('filterType').value = 'ALL';
    
    // Load all data (no filter)
    loadAllMutations();
  }
  
  function createStockMovementsSheet() {
    if (!mutUserEmail) {
      alert('Sesi tidak valid. Silakan login kembali.');
      return;
    }
    
    const tbody = document.getElementById('mutationsTableBody');
    tbody.innerHTML = `
      <tr>
        <td colspan="7" class="loading-state">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Membuat sheet StockMovements...</p>
        </td>
      </tr>
    `;
    
    google.script.run
      .withSuccessHandler(function(result) {
        console.log('Create sheet result:', result);
        if (result && result.success) {
          alert('Sheet StockMovements berhasil dibuat!');
          loadMutations();
        } else {
          alert('Gagal membuat sheet: ' + (result?.message || 'Unknown error'));
          loadMutations();
        }
      })
      .withFailureHandler(function(error) {
        console.error('Error creating sheet:', error);
        alert('Error: ' + error.message);
        loadMutations();
      })
      .smInitializeStockMovements(mutUserEmail);
  }
</script>
